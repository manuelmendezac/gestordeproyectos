<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas - SCALEXONE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .task-item[data-status="âœ…"] span {
            text-decoration: line-through;
            color: #6b7280; /* text-gray-500 */
        }
        .status-icon {
            transition: transform 0.1s ease-in-out;
        }
        .status-icon:hover {
            transform: scale(1.2);
        }
        .note-icon {
            transition: transform 0.1s ease-in-out, color 0.1s ease-in-out;
        }
        .note-icon:hover {
            transform: scale(1.2);
        }
        .note-icon.has-note {
            color: #60a5fa; /* text-blue-400 */
        }
        .note-display {
            white-space: pre-wrap; /* Mantiene saltos de lÃ­nea y espacios */
            word-break: break-word; /* Evita que los links largos rompan el layout */
        }
        .note-display a {
            color: #60a5fa; /* text-blue-400 */
            text-decoration: underline;
        }
        .note-display a:hover {
            color: #93c5fd; /* text-blue-300 */
        }
        /* Estilos para el acordeÃ³n */
        .accordion-header {
            cursor: pointer;
            transition: background-color 0.2s ease-out;
        }
        .accordion-header:hover {
            background-color: #374151; /* bg-gray-700 */
        }
        .accordion-arrow {
            display: inline-block;
            transition: transform 0.2s ease-out;
            margin-right: 0.5rem;
            font-size: 0.8em;
            width: 1.5rem; /* Ancho fijo para alinear */
        }
        .accordion-header.open .accordion-arrow {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Pantalla de Login (Oculta si ya estÃ¡ logueado) -->
    <div id="login-container" class="hidden flex items-center justify-center min-h-screen">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <h1 class="text-3xl font-bold text-white mb-6">ðŸ“‹ Gestor de Proyectos</h1>
            <p class="text-gray-400 mb-8">Por favor, inicia sesiÃ³n para continuar.</p>
            <button id="google-login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full flex items-center justify-center">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l0.001-0.001l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Iniciar sesiÃ³n con Google
            </button>
            <div class="text-sm text-gray-400 mt-6">
                Estado: <span id="auth-status-login" class="font-semibold text-yellow-400">Desconectado</span>
            </div>
        </div>
    </div>


    <!-- Contenedor Principal de la App (Oculto al inicio) -->
    <div id="main-app-container" class="hidden">
        <!-- Contenedor Principal -->
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-700">
                <h1 id="project-title" class="text-3xl font-bold text-white mb-2 md:mb-0">ðŸ“‹ Gestor de Proyecto: SCALEXONE</h1>
                <div class="text-sm text-gray-400">
                    Estado: <span id="auth-status-main" class="font-semibold text-green-400">Conectado</span>
                </div>
            </header>

            <!-- Contenedor del Proyecto -->
            <div id="project-container" class="space-y-6">
                <!-- El contenido se generarÃ¡ aquÃ­ -->
            </div>
        </div>

        <!-- SecciÃ³n de Tareas Prioritarias -->
        <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">ðŸŽ¯ Tareas Prioritarias</h2>
            <div class="bg-gray-800 rounded-lg shadow-md p-4">
                <ul id="priority-list" class="space-y-2 mb-4">
                    <li class="text-gray-500 italic">Cargando tareas prioritarias...</li>
                </ul>
                <div class="flex">
                    <input id="priority-input" type="text" class="flex-grow p-2 rounded-l-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="AÃ±adir nueva tarea prioritaria...">
                    <button id="add-priority-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-md">
                        AÃ±adir
                    </button>
                </div>
            </div>
        </div>
        <!-- Fin de Tareas Prioritarias -->
    </div>

    <!-- Indicador de Carga Global (Oculto al inicio) -->
    <div id="loading-spinner" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="mt-2 text-lg font-medium text-white">Conectando...</span>
        </div>
    </div>

    <!-- Modal de Mensajes/Errores -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p id="message-text" class="text-lg text-white mb-4">Mensaje</p>
            <button onclick="hideMessage()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                Entendido
            </button>
        </div>
    </div>

    <!-- Modal de Notas -->
    <div id="note-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg mx-auto w-full">
            <h3 class="text-xl font-semibold text-white mb-4">AÃ±adir/Editar Nota</h3>
            <textarea id="note-textarea" rows="5" class="w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-note-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg">
                    Cancelar
                </button>
                <button id="save-note-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">
                    Guardar Nota
                </button>
            </div>
        </div>
    </div>

    <!-- Script de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,     // <-- REQUERIDO
            signInWithPopup       // <-- REQUERIDO
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ConfiguraciÃ³n y Variables Globales ---
        const firebaseConfig = {
            apiKey: "AIzaSyAk9eA_iMIs8vQza199Hp_EIvVm7ughIFQ",
            authDomain: "organizador--scalex.firebaseapp.com",
            projectId: "organizador--scalex",
            storageBucket: "organizador--scalex.firebasestorage.app",
            messagingSenderId: "69457091494",
            appId: "1:69457091494:web:e9c4224f03311e75e48d67",
            measurementId: "G-R549Q9R2EN"
        };
        
        const appId = firebaseConfig.projectId || 'default-scalexone-app';

        let db, auth;
        let userId = null;
        let projectDocRef = null; 
        
        let projectData = []; 
        let priorityTasks = []; 
        let openAccordions = new Set(); 
        let savedScrollY = 0; 
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.getElementById('loading-text');
        
        // --- Elementos de UI ---
        const loginContainer = document.getElementById('login-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const authStatusLogin = document.getElementById('auth-status-login');
        const authStatusMain = document.getElementById('auth-status-main');

        // --- Elementos de Modales ---
        const noteModal = document.getElementById('note-modal');
        const noteTextarea = document.getElementById('note-textarea');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const cancelNoteBtn = document.getElementById('cancel-note-btn');
        let currentEditingItem = null;
        let currentEditingPriorityItemIndex = null;

        // --- Datos Iniciales (Plantilla para nuevos proyectos) ---
        const initialProjectData = [
            { "id": "1", "title": "ðŸ—ï¸ 1. INFRAESTRUCTURA BASE", "tasks": [
                {"id": "1.1", "title": "1.1 AutenticaciÃ³n y Usuarios", "items": [
                    {"id": "1.1.1", "text": "Sistema de registro/login con Supabase Auth", "status": "âœ…"},
                    {"id": "1.1.2", "text": "Soporte para Email y Google OAuth", "status": "âœ…"},
                    {"id": "1.1.3", "text": "GestiÃ³n de perfiles de usuario", "status": "âœ…"},
                    {"id": "1.1.4", "text": "Sistema de roles (admin, moderador, usuario, superadmin, owner)", "status": "âœ…"},
                    {"id": "1.1.5", "text": "PolÃ­ticas RLS (Row Level Security) configuradas", "status": "âœ…"},
                    {"id": "1.1.6", "text": "Verificar que el registro crea correctamente usuarios en tabla `usuarios`", "status": "â³"},
                    {"id": "1.1.7", "text": "Corregir asignaciÃ³n de `afiliado_referente` en registro", "status": "â³"}
                ]},
                {"id": "1.2", "title": "1.2 Base de Datos", "items": [
                    {"id": "1.2.1", "text": "Tabla `usuarios` con campos completos", "status": "âœ…"},
                    {"id": "1.2.2", "text": "Tabla `comunidades` para gestiÃ³n multi-tenant", "status": "âœ…"},
                    {"id": "1.2.3", "text": "Tabla `canales` para organizaciÃ³n de contenido", "status": "âœ…"},
                    {"id": "1.2.4", "text": "Sistema de relaciones normalizadas", "status": "âœ…"},
                    {"id": "1.2.5", "text": "Vistas y funciones SQL optimizadas", "status": "âœ…"},
                    {"id": "1.2.6", "text": "Unificar `community_id` en todas las tablas (migraciÃ³n pendiente)", "status": "â³"}
                ]},
                {"id": "1.3", "title": "1.3 Deployment y Hosting", "items": [
                    {"id": "1.3.1", "text": "Frontend deployado en Vercel", "status": "âœ…"},
                    {"id": "1.3.2", "text": "Base de datos en Supabase", "status": "âœ…"},
                    {"id": "1.3.3", "text": "Storage para archivos en Supabase", "status": "âœ…"},
                    {"id": "1.3.4", "text": "ConfiguraciÃ³n de variables de entorno", "status": "âœ…"},
                    {"id": "1.3.5", "text": "Microservicio Stripe en stripe.scalexone.app", "status": "âœ…"}
                ]}
            ]},
            { "id": "2", "title": "ðŸŽ¨ 2. FRONTEND Y UX", "tasks": [
                {"id": "2.1", "title": "2.1 NavegaciÃ³n y Layout", "items": [
                    {"id": "2.1.1", "text": "Sistema de rutas con React Router", "status": "âœ…"},
                    {"id": "2.1.2", "text": "Navbar responsive (ScrollNavbar, SecondNavbar)", "status": "âœ…"},
                    {"id": "2.1.3", "text": "Sidebar colapsable", "status": "âœ…"},
                    {"id": "2.1.4", "text": "Topbar con notificaciones", "status": "âœ…"},
                    {"id": "2.1.5", "text": "Footer", "status": "âœ…"},
                    {"id": "2.1.6", "text": "Sistema de menÃºs dinÃ¡micos por comunidad", "status": "âœ…"},
                    {"id": "2.1.7", "text": "MenÃº secundario visible en todas las pÃ¡ginas", "status": "âœ…"}
                ]},
                {"id": "2.2", "title": "2.2 PÃ¡ginas Principales", "items": [
                    {"id": "2.2.1", "text": "PÃ¡gina de inicio (Hero)", "status": "âœ…"},
                    {"id": "2.2.2", "text": "Dashboard principal", "status": "âœ…"},
                    {"id": "2.2.3", "text": "Classroom (gestiÃ³n de cursos y mÃ³dulos)", "status": "âœ…"},
                    {"id": "2.2.4", "text": "Comunidad (foros y canales)", "status": "âœ…"},
                    {"id": "2.2.5", "text": "Chat en tiempo real", "status": "âœ…"},
                    {"id": "2.2.6", "text": "PÃ¡gina About", "status": "âœ…"},
                    {"id": "2.2.7", "text": "Marketplace pÃºblico", "status": "âœ…"},
                    {"id": "2.2.8", "text": "Launchpad (sistema de eventos)", "status": "âœ…"}
                ]},
                {"id": "2.3", "title": "2.3 Componentes Reutilizables", "items": [
                    {"id": "2.3.1", "text": "Botones personalizados", "status": "âœ…"},
                    {"id":"2.3.2", "text": "Modales", "status": "âœ…"},
                    {"id": "2.3.3", "text": "Forms con validaciÃ³n", "status": "âœ…"},
                    {"id": "2.3.4", "text": "Tarjetas de productos", "status": "âœ…"},
                    {"id": "2.3.5", "text": "Sistema de iconos", "status": "âœ…"},
                    {"id": "2.3.6", "text": "Spinners de carga", "status": "âœ…"}
                ]}
            ]},
            { "id": "3", "title": "ðŸ›’ 3. MARKETPLACE", "tasks": [
                {"id": "3.1", "title": "3.1 Cursos Marketplace", "items": [
                    {"id": "3.1.1", "text": "Tabla `cursos_marketplace`", "status": "âœ…"},
                    {"id": "3.1.2", "text": "CRUD completo desde panel admin", "status": "âœ…"},
                    {"id": "3.1.3", "text": "Subida de imÃ¡genes", "status": "âœ…"},
                    {"id": "3.1.4", "text": "CategorizaciÃ³n y filtros", "status": "âœ…"},
                    {"id": "3.1.5", "text": "Vista pÃºblica responsive", "status": "âœ…"},
                    {"id": "3.1.6", "text": "IntegraciÃ³n con sistema de suscripciones", "status": "âœ…"},
                    {"id": "3.1.7", "text": "Agregar campo `stripe_price_id` a tabla", "status": "â³"},
                    {"id": "3.1.8", "text": "Crear producto en Stripe automÃ¡ticamente al guardar curso", "status": "â³"}
                ]},
                {"id": "3.2", "title": "3.2 Servicios Marketplace", "items": [
                    {"id": "3.2.1", "text": "Tabla `servicios_marketplace`", "status": "âœ…"},
                    {"id": "3.2.2", "text": "Soporte para pago Ãºnico y suscripciÃ³n", "status": "âœ…"},
                    {"id": "3.2.3", "text": "CRUD completo", "status": "âœ…"},
                    {"id": "3.2.4", "text": "Badges informativos (Pago Ãšnico / SuscripciÃ³n)", "status": "âœ…"},
                    {"id": "3.2.5", "text": "Filtros inteligentes por categorÃ­a", "status": "âœ…"},
                    {"id": "3.2.6", "text": "Vista pÃºblica con diseÃ±o premium", "status": "âœ…"},
                    {"id": "3.2.7", "text": "Funcionalidad de ediciÃ³n completa", "status": "âœ…"},
                    {"id": "3.2.8", "text": "Agregar campo `stripe_price_id` a tabla", "status": "â³"},
                    {"id": "3.2.9", "text": "Crear producto en Stripe automÃ¡ticamente al guardar servicio", "status": "â³"}
                ]},
                {"id": "3.3", "title": "3.3 Funcionalidades Marketplace", "items": [
                    {"id": "3.3.1", "text": "Filtros clickeables (Cursos, Servicios, Software/SaaS, Productos, Propiedades)", "status": "âœ…"},
                    {"id": "3.3.2", "text": "BÃºsqueda por tÃ­tulo y descripciÃ³n", "status": "âœ…"},
                    {"id": "3.3.3", "text": "EstadÃ­sticas en tiempo real", "status": "âœ…"},
                    {"id": "3.3.4", "text": "DiseÃ±o tipo Netflix horizontal", "status": "âœ…"},
                    {"id": "3.3.5", "text": "Colores diferenciados (dorado cursos, pÃºrpura servicios)", "status": "âœ…"}
                ]}
            ]},
            { "id": "4", "title": "ðŸ‘¥ 4. SISTEMA DE COMUNIDAD", "tasks": [
                {"id": "4.1", "title": "4.1 Canales", "items": [
                    {"id": "4.1.1", "text": "Tabla `canales` con sistema de jerarquÃ­a", "status": "âœ…"},
                    {"id": "4.1.2", "text": "Panel admin con drag & drop para reordenamiento", "status": "âœ…"},
                    {"id": "4.1.3", "text": "Canales predefinidos (#Presentate, #Chat General, #CANAL VIP)", "status": "âœ…"},
                    {"id": "4.1.4", "text": "Permisos por canal", "status": "âœ…"},
                    {"id": "4.1.5", "text": "Sistema de mensajerÃ­a", "status": "âœ…"},
                    {"id": "4.1.6", "text": "RestricciÃ³n por suscripciÃ³n/niveles (funciones SQL implementadas)", "status": "âœ…"},
                    {"id": "4.1.7", "text": "Verificar que las restricciones funcionan correctamente en frontend", "status": "â³"},
                    {"id": "4.1.8", "text": "Agregar checks visuales de restricciÃ³n en mÃ³dulos", "status": "â³"}
                ]},
                {"id": "4.2", "title": "4.2 ConfiguraciÃ³n", "items": [
                    {"id": "4.2.1", "text": "ConfiguraciÃ³n por comunidad", "status": "âœ…"},
                    {"id": "4.2.2", "text": "MenÃº secundario personalizable", "status": "âœ…"},
                    {"id": "4.2.3", "text": "Temas de color dinÃ¡micos", "status": "âœ…"},
                    {"id": "4.2.4", "text": "Upload de logos e imÃ¡genes", "status": "âœ…"}
                ]}
            ]},
            { "id": "5", "title": "ðŸ’° 5. SISTEMA DE SUSCRIPCIONES", "tasks": [
                {"id": "5.1", "title": "5.1 Planes de SuscripciÃ³n", "items": [
                    {"id": "5.1.1", "text": "Tabla `planes_suscripcion`", "status": "âœ…"},
                    {"id": "5.1.2", "text": "CaracterÃ­sticas JSONB flexibles", "status": "âœ…"},
                    {"id": "5.1.3", "text": "Soporte multi-moneda (USD, EUR, MXN, COP)", "status": "âœ…"},
                    {"id": "5.1.4", "text": "Sistema de pruebas gratis configurable", "status": "âœ…"},
                    {"id": "5.1.5", "text": "CategorizaciÃ³n (BÃ¡sico, Premium, Enterprise)", "status": "âœ…"},
                    {"id": "5.1.6", "text": "Colores personalizados", "status": "âœ…"},
                    {"id": "5.1.7", "text": "Planes destacados", "status": "âœ…"},
                    {"id": "5.1.8", "text": "Agregar campo `stripe_price_id` a tabla (CRÃTICO)", "status": "â³"},
                    {"id": "5.1.9", "text": "Crear producto en Stripe automÃ¡ticamente al guardar plan", "status": "â³"}
                ]},
                {"id": "5.2", "title": "5.2 GestiÃ³n de Suscripciones", "items": [
                    {"id": "5.2.1", "text": "Portal de Suscripciones integrado", "status": "âœ…"},
                    {"id": "5.2.2", "text": "ConexiÃ³n automÃ¡tica con cursos y servicios", "status": "âœ…"},
                    {"id": "5.2.3", "text": "EstadÃ­sticas y mÃ©tricas", "status": "âœ…"},
                    {"id": "5.2.4", "text": "Tasa de conversiÃ³n automÃ¡tica", "status": "âœ…"},
                    {"id": "5.2.5", "text": "Plan mÃ¡s popular identificado", "status": "âœ…"},
                    {"id": "5.2.6", "text": "Verificar activaciÃ³n automÃ¡tica desde webhook de Stripe", "status": "â³"},
                    {"id": "5.2.7", "text": "Manejar cancelaciones y renovaciones", "status": "â³"}
                ]},
                {"id": "5.3", "title": "5.3 Restricciones por SuscripciÃ³n/Niveles", "items": [
                    {"id": "5.3.1", "text": "Funciones SQL para verificar acceso por suscripciÃ³n", "status": "âœ…"},
                    {"id": "5.3.2", "text": "VerificaciÃ³n de acceso en canales", "status": "âœ…"},
                    {"id": "5.3.3", "text": "Implementar checks de restricciÃ³n en mÃ³dulos de Classroom", "status": "â³"},
                    {"id": "5.3.4", "text": "Implementar checks de restricciÃ³n en herramientas (Alpha X100, Trading Lab, etc.)", "status": "â³"},
                    {"id": "5.3.5", "text": "Agregar UI visual cuando el contenido estÃ¡ restringido", "status": "â³"},
                    {"id": "5.3.6", "text": "Mensajes informativos sobre quÃ© plan se necesita", "status": "â³"}
                ]}
            ]},
            { "id": "6", "title": "ðŸ¤ 6. SISTEMA DE AFILIADOS", "tasks": [
                {"id": "6.1", "title": "6.1 Estructura Base", "items": [
                    {"id": "6.1.1", "text": "Sistema de cÃ³digos IB Ãºnicos (IB001, IB002, etc.)", "status": "âœ…"},
                    {"id": "6.1.2", "text": "CÃ³digos independientes por comunidad", "status": "âœ…"},
                    {"id": "6.1.3", "text": "CÃ³digos Hospper con sufijo `H`", "status": "âœ…"},
                    {"id": "6.1.4", "text": "Dashboard completo para afiliados", "status": "âœ…"},
                    {"id": "6.1.5", "text": "Historial de transacciones", "status": "âœ…"},
                    {"id": "6.1.6", "text": "Ejecutar scripts SQL de correcciÃ³n pendientes", "status": "â³"},
                    {"id": "6.1.7", "text": "Verificar que el tracking funciona correctamente", "status": "â³"}
                ]},
                {"id": "6.2", "title": "6.2 Tracking", "items": [
                    {"id": "6.2.1", "text": "Tabla `codigos_afiliado`", "status": "âœ…"},
                    {"id": "6.2.2", "text": "Tabla `clicks_afiliado`", "status": "âœ…"},
                    {"id": "6.2.3", "text": "Tabla `comisiones_afiliado`", "status": "âœ…"},
                    {"id": "6.2.4", "text": "Tabla `conversiones_afiliado`", "status": "âœ…"},
                    {"id": "6.2.5", "text": "Funciones RPC optimizadas", "status": "âœ…"},
                    {"id": "6.2.6", "text": "Verificar que se registran clicks correctamente", "status": "â³"},
                    {"id": "6.2.7", "text": "Verificar que se registran leads al registrarse usuarios", "status": "â³"},
                    {"id": "6.2.8", "text": "Eliminar creaciÃ³n de ventas falsas automÃ¡ticas", "status": "â³"}
                ]},
                {"id": "6.3", "title": "6.3 Funcionalidades", "items": [
                    {"id": "6.3.1", "text": "GeneraciÃ³n automÃ¡tica de cÃ³digos", "status": "âœ…"},
                    {"id": "6.3.2", "text": "Links de afiliado personalizables", "status": "âœ…"},
                    {"id": "6.3.3", "text": "CÃ¡lculo de saldo disponible", "status": "âœ…"},
                    {"id": "6.3.4", "text": "Sistema de retiros con validaciones", "status": "âœ…"},
                    {"id": "6.3.5", "text": "Transferencias entre cÃ³digos IB", "status": "âœ…"},
                    {"id": "6.3.6", "text": "Comisiones multinivel (3 niveles) - estructura implementada", "status": "âœ…"},
                    {"id": "6.3.7", "text": "Verificar que las comisiones multinivel se calculan correctamente", "status": "â³"},
                    {"id": "6.3.8", "text": "Verificar que las comisiones se asignan automÃ¡ticamente en ventas", "status": "â³"}
                ]},
                {"id": "6.4", "title": "6.4 Panel de Afiliados", "items": [
                    {"id": "6.4.1", "text": "Dashboard con mÃ©tricas en tiempo real", "status": "âœ…"},
                    {"id": "6.4.2", "text": "PÃ¡gina de enlaces de afiliado", "status": "âœ…"},
                    {"id": "6.4.3", "text": "PÃ¡gina de retiros", "status": "âœ…"},
                    {"id": "6.4.4", "text": "PÃ¡gina de transferencias", "status": "âœ…"},
                    {"id": "6.4.5", "text": "PÃ¡gina de historial", "status": "âœ…"},
                    {"id": "6.4.6", "text": "PÃ¡gina multinivel", "status": "âœ…"},
                    {"id": "6.4.7", "text": "Conectar historial a datos reales", "status": "â³"},
                    {"id": "6.4.8", "text": "Verificar que todas las mÃ©tricas se muestran correctamente", "status": "â³"}
                ]},
                {"id": "6.5", "title": "6.5 Sistema Multinivel Completo", "items": [
                    {"id": "6.5.1", "text": "Verificar que el sistema de 3 niveles funciona correctamente", "status": "â³"},
                    {"id": "6.5.2", "text": "Verificar asignaciÃ³n de `afiliado_referente` en todos los niveles", "status": "â³"},
                    {"id": "6.5.3", "text": "Probar flujo completo: registro â†’ compra â†’ comisiÃ³n multinivel", "status": "â³"},
                    {"id": "6.5.4", "text": "Verificar notificaciones a todos los niveles", "status": "â³"}
                ]}
            ]},
            { "id": "7", "title": "ðŸ’³ 7. INTEGRACIÃ“N DE PAGOS", "tasks": [
                {"id": "7.1", "title": "7.1 Stripe", "items": [
                    {"id": "7.1.1", "text": "Microservicio Stripe deployado", "status": "âœ…"},
                    {"id": "7.1.2", "text": "Endpoints API implementados", "status": "âœ…"},
                    {"id": "7.1.3", "text": "Servicio frontend `stripeService.ts`", "status": "âœ…"},
                    {"id": "7.1.4", "text": "Componente `StripePaymentButton`", "status": "âœ…"},
                    {"id": "7.1.5", "text": "Variables de entorno configuradas", "status": "âœ…"},
                    {"id": "7.1.6", "text": "Webhook configurado para eventos", "status": "âœ…"},
                    {"id": "7.1.7", "text": "Conectar botones de compra en marketplace", "status": "â³"},
                    {"id": "7.1.8", "text": "Crear pÃ¡ginas de Ã©xito/error despuÃ©s del pago (`/success`, `/cancel`)", "status": "â³"},
                    {"id": "7.1.9", "text": "Verificar creaciÃ³n de ventas en BD desde webhook", "status": "â³"},
                    {"id": "7.1.10", "text": "Integrar comisiones automÃ¡ticas de afiliados en webhook", "status": "â³"},
                    {"id": "7.1.11", "text": "Agregar campo `stripe_price_id` a todas las tablas de productos", "status": "â³"},
                    {"id": "7.1.12", "text": "Crear productos en Stripe automÃ¡ticamente al guardar", "status": "â³"},
                    {"id": "7.1.13", "text": "Probar flujo completo de pago (crear â†’ pagar â†’ activar)", "status": "â³"}
                ]},
                {"id": "7.2", "title": "7.2 Pagos Crypto (NOWPayments/CoinGate)", "items": [
                    {"id": "7.2.1", "text": "Endpoints API para NOWPayments", "status": "âœ…"},
                    {"id": "7.2.2", "text": "Endpoints API para CoinGate", "status": "âœ…"},
                    {"id": "7.2.3", "text": "Webhooks implementados", "status": "âœ…"},
                    {"id": "7.2.4", "text": "Verificar que los webhooks funcionan correctamente", "status": "â³"},
                    {"id": "7.2.5", "text": "Probar flujo completo de pago crypto", "status": "â³"},
                    {"id": "7.2.6", "text": "Verificar creaciÃ³n de ventas en BD", "status": "â³"},
                    {"id": "7.2.7", "text": "Integrar comisiones automÃ¡ticas de afiliados", "status": "â³"},
                    {"id": "7.2.8", "text": "Panel admin para gestionar pagos crypto", "status": "â³"}
                ]},
                {"id": "7.3", "title": "7.3 Otros MÃ©todos de Pago", "items": [
                    {"id": "7.3.1", "text": "Integrar PayPal", "status": "âŒ"},
                    {"id": "7.3.2", "text": "Integrar pagos locales (Yape, Plin, Nequi, etc.)", "status": "âŒ"},
                    {"id": "7.3.3", "text": "Sistema de pagos contraentrega", "status": "âŒ"},
                    {"id": "7.3.4", "text": "Panel admin para gestionar mÃ©todos de pago", "status": "âŒ"}
                ]}
            ]},
            { "id": "8", "title": "ðŸ“š 8. SISTEMA CLASSROOM", "tasks": [
                {"id": "8.1", "title": "8.1 Funcionalidades Base", "items": [
                    {"id": "8.1.1", "text": "GestiÃ³n de cursos y mÃ³dulos", "status": "âœ…"},
                    {"id": "8.1.2", "text": "Subida y visualizaciÃ³n de videos", "status": "âœ…"},
                    {"id": "8.1.3", "text": "Sistema de progreso", "status": "âœ…"},
                    {"id": "8.1.4", "text": "EdiciÃ³n de contenido", "status": "âœ…"},
                    {"id": "8.1.5", "text": "OrganizaciÃ³n por mÃ³dulos", "status": "âœ…"},
                    {"id": "8.1.6", "text": "Implementar restricciones por suscripciÃ³n/niveles", "status": "â³"},
                    {"id": "8.1.7", "text": "Agregar checks visuales de restricciÃ³n", "status": "â³"}
                ]},
                {"id": "8.2", "title": "8.2 Funcionalidades Avanzadas", "items": [
                    {"id": "8.2.1", "text": "Certificados de finalizaciÃ³n automÃ¡ticos", "status": "âŒ"},
                    {"id": "8.2.2", "text": "Sistema de calificaciones y exÃ¡menes", "status": "âŒ"},
                    {"id": "8.2.3", "text": "Comentarios y preguntas en videos", "status": "âŒ"},
                    {"id": "8.2.4", "text": "EstadÃ­sticas de progreso detalladas", "status": "âŒ"}
                ]}
            ]},
            { "id": "9", "title": "ðŸš€ 9. SISTEMA LAUNCHPAD", "tasks": [
                {"id": "9.1", "title": "9.1 Funcionalidades", "items": [
                    {"id": "9.1.1", "text": "Sistema de eventos y calendario", "status": "âœ…"},
                    {"id": "9.1.2", "text": "Video destacado con contador regresivo", "status": "âœ…"},
                    {"id": "9.1.3", "text": "Barra lateral desplegable con logo personalizable", "status": "âœ…"},
                    {"id": "9.1.4", "text": "Botones personalizables con redirecciÃ³n", "status": "âœ…"},
                    {"id": "9.1.5", "text": "Sistema de calificaciones y comentarios", "status": "âœ…"},
                    {"id": "9.1.6", "text": "IntegraciÃ³n con sistema de referidos", "status": "âœ…"},
                    {"id": "9.1.7", "text": "Carga de imÃ¡genes en bucket dedicado", "status": "âœ…"},
                    {"id": "9.1.8", "text": "Editor completo desde panel admin", "status": "âœ…"},
                    {"id": "9.1.9", "text": "Colores unificados (paleta dorada)", "status": "âœ…"},
                    {"id": "9.1.10", "text": "Responsive design", "status": "âœ…"}
                ]}
            ]},
            { "id": "10", "title": "âš™ï¸ 10. PANEL ADMINISTRATIVO", "tasks": [
                {"id": "10.1", "title": "10.1 Secciones Implementadas", "items": [
                    {"id": "10.1.1", "text": "Dashboard general", "status": "âœ…"},
                    {"id": "10.1.2", "text": "ConfiguraciÃ³n de comunidad", "status": "âœ…"},
                    {"id": "10.1.3", "text": "GestiÃ³n de canales (con drag & drop)", "status": "âœ…"},
                    {"id": "10.1.4", "text": "GestiÃ³n de cursos marketplace", "status": "âœ…"},
                    {"id": "10.1.5", "text": "GestiÃ³n de servicios marketplace", "status": "âœ…"},
                    {"id": "10.1.6", "text": "Portal de Suscripciones", "status": "âœ…"},
                    {"id": "10.1.7", "text": "Panel de Finanzas (Suscripciones, Ventas, Transacciones)", "status": "âœ…"},
                    {"id": "10.1.8", "text": "Panel de Afiliados", "status": "âœ…"},
                    {"id": "10.1.9", "text": "GestiÃ³n de Launchpad", "status": "âœ…"},
                    {"id": "10.1.10", "text": "ConfiguraciÃ³n general", "status": "âœ…"},
                    {"id": "10.1.11", "text": "Email Marketing Panel", "status": "âœ…"}
                ]},
                {"id": "10.2", "title": "10.2 Funcionalidades Admin", "items": [
                    {"id": "10.2.1", "text": "Crear, editar, eliminar productos", "status": "âœ…"},
                    {"id": "10.2.2", "text": "Activar/desactivar productos", "status": "âœ…"},
                    {"id": "10.2.3", "text": "Subir imÃ¡genes", "status": "âœ…"},
                    {"id": "10.2.4", "text": "Configurar precios y caracterÃ­sticas", "status": "âœ…"},
                    {"id": "10.2.5", "text": "EstadÃ­sticas y mÃ©tricas", "status": "âœ…"},
                    {"id": "10.2.6", "text": "Reportes", "status": "âœ…"}
                ]}
            ]},
            { "id": "11", "title": "ðŸ“§ 11. SISTEMA DE EMAIL MARKETING", "tasks": [
                {"id": "11.1", "title": "11.1 Infraestructura", "items": [
                    {"id": "11.1.1", "text": "IntegraciÃ³n con SendGrid", "status": "âœ…"},
                    {"id": "11.1.2", "text": "IntegraciÃ³n con Resend", "status": "âœ…"},
                    {"id": "11.1.3", "text": "Sistema de plantillas en Supabase Storage", "status": "âœ…"},
                    {"id": "11.1.4", "text": "Variables dinÃ¡micas con Handlebars", "status": "âœ…"},
                    {"id": "11.1.5", "text": "White-Label: colores y branding dinÃ¡micos", "status": "âœ…"},
                    {"id": "11.1.6", "text": "Verificar que todas las plantillas funcionan correctamente", "status": "â³"},
                    {"id": "11.1.7", "text": "Verificar que los emails se envÃ­an correctamente", "status": "â³"}
                ]},
                {"id": "11.2", "title": "11.2 Funcionalidades", "items": [
                    {"id": "11.2.1", "text": "Email de bienvenida al registrarse", "status": "âœ…"},
                    {"id": "11.2.2", "text": "Email cuando se crea un curso", "status": "âœ…"},
                    {"id": "11.2.3", "text": "Email masivo cuando admin/moderador publica", "status": "âœ…"},
                    {"id": "11.2.4", "text": "Notificaciones in-app (campanita)", "status": "âœ…"},
                    {"id": "11.2.5", "text": "Email de confirmaciÃ³n de pago exitoso", "status": "â³"},
                    {"id": "11.2.6", "text": "Email de pago fallido", "status": "â³"},
                    {"id": "11.2.7", "text": "Email de activaciÃ³n de suscripciÃ³n", "status": "â³"},
                    {"id": "11.2.8", "text": "Email de cancelaciÃ³n de suscripciÃ³n", "status": "â³"},
                    {"id": "11.2.9", "text": "Sequence de emails automÃ¡ticos", "status": "â³"},
                    {"id": "11.2.10", "text": "Recordatorios de vencimiento", "status": "â³"}
                ]},
                {"id": "11.3", "title": "11.3 Notificaciones Push", "items": [
                    {"id": "11.3.1", "text": "Componente `PushNotificationManager.tsx` (frontend)", "status": "âœ…"},
                    {"id": "11.3.2", "text": "Service Worker implementado", "status": "âœ…"},
                    {"id": "11.3.3", "text": "Endpoint para guardar suscripciones push en BD", "status": "â³"},
                    {"id": "11.3.4", "text": "Endpoint para enviar push notifications desde servidor", "status": "â³"},
                    {"id": "11.3.5", "text": "Tabla en Supabase para almacenar suscripciones push", "status": "â³"},
                    {"id": "11.3.6", "text": "IntegraciÃ³n de push en webhooks de pago", "status": "â³"},
                    {"id": "11.3.7", "text": "Configurar VAPID keys", "status": "â³"}
                ]}
            ]},
            { "id": "12", "title": "ðŸ”” 12. SISTEMA DE NOTIFICACIONES", "tasks": [
                {"id": "12.1", "title": "12.1 Notificaciones In-App", "items": [
                    {"id": "12.1.1", "text": "Tabla `notificaciones`", "status": "âœ…"},
                    {"id": "12.1.2", "text": "Sistema de campanita en Topbar", "status": "âœ…"},
                    {"id": "12.1.3", "text": "ActualizaciÃ³n automÃ¡tica cada 30 segundos", "status": "âœ…"},
                    {"id": "12.1.4", "text": "Notificaciones filtradas por comunidad", "status": "âœ…"},
                    {"id": "12.1.5", "text": "Marcar como leÃ­das", "status": "âœ…"},
                    {"id": "12.1.6", "text": "Verificar que todas las notificaciones se crean correctamente", "status": "â³"}
                ]},
                {"id": "12.2", "title": "12.2 Notificaciones de Afiliados", "items": [
                    {"id": "12.2.1", "text": "Notificaciones de registro", "status": "âœ…"},
                    {"id": "12.2.2", "text": "Notificaciones de ventas", "status": "âœ…"},
                    {"id": "12.2.3", "text": "Notificaciones de suscripciones", "status": "âœ…"},
                    {"id": "12.2.4", "text": "Sistema multinivel (notifica a todos los niveles)", "status": "âœ…"},
                    {"id": "12.2.5", "text": "Verificar que las notificaciones se envÃ­an a todos los niveles", "status": "â³"},
                    {"id": "12.2.6", "text": "Verificar que las notificaciones incluyen informaciÃ³n correcta", "status": "â³"}
                ]},
                {"id": "12.3", "title": "12.3 Notificaciones de Ventas, Leads y Registros", "items": [
                    {"id": "12.3.1", "text": "Notificaciones de nuevos registros (implementado)", "status": "âœ…"},
                    {"id": "12.3.2", "text": "Notificaciones de ventas (implementado en webhook)", "status": "âœ…"},
                    {"id": "12.3.3", "text": "Verificar que las notificaciones de ventas se envÃ­an correctamente", "status": "â³"},
                    {"id": "12.3.4", "text": "Verificar que las notificaciones de leads se envÃ­an correctamente", "status": "â³"},
                    {"id": "12.3.5", "text": "Notificaciones de nuevos leads (pendiente verificar)", "status": "â³"},
                    {"id": "12.3.6", "text": "Dashboard de notificaciones para admin", "status": "â³"}
                ]}
            ]},
            { "id": "13", "title": "ðŸ”’ 13. SEGURIDAD Y PERMISOS", "tasks": [
                {"id": "13.1", "title": "13.1 Restricciones por SuscripciÃ³n/Niveles", "items": [
                    {"id": "13.1.1", "text": "Funciones SQL para verificar acceso", "status": "âœ…"},
                    {"id": "13.1.2", "text": "VerificaciÃ³n en canales", "status": "âœ…"},
                    {"id": "13.1.3", "text": "VerificaciÃ³n en Alpha X100", "status": "âœ…"},
                    {"id": "13.1.4", "text": "Implementar en todos los mÃ³dulos de Classroom", "status": "â³"},
                    {"id": "13.1.5", "text": "Implementar en Trading Lab", "status": "â³"},
                    {"id": "13.1.6", "text": "Implementar en Crypto Health Scanner", "status": "â³"},
                    {"id": "13.1.7", "text": "Implementar en todas las herramientas premium", "status": "â³"},
                    {"id": "13.1.8", "text": "Agregar UI visual de restricciÃ³n", "status": "â³"},
                    {"id": "13.1.9", "text": "Mensajes informativos sobre planes requeridos", "status": "â³"}
                ]},
                {"id": "13.2", "title": "13.2 AutenticaciÃ³n 2FA", "items": [
                    {"id": "13.2.1", "text": "Integrar autenticador Google (2FA)", "status": "âŒ"},
                    {"id": "13.2.2", "text": "Requerir 2FA para retiros y transferencias", "status": "âŒ"},
                    {"id": "13.2.3", "text": "Panel de configuraciÃ³n de 2FA", "status": "âŒ"}
                ]},
                {"id": "13.3", "title": "13.3 AuditorÃ­a y Logs", "items": [
                    {"id": "13.3.1", "text": "Mejorar sistema de logs", "status": "â³"},
                    {"id": "13.3.2", "text": "Implementar rate limiting", "status": "â³"},
                    {"id": "13.3.3", "text": "Sistema de auditorÃ­a de acciones crÃ­ticas", "status": "â³"}
                ]}
            ]},
            { "id": "14", "title": "ðŸ’° 14. WALLET XCOIN", "tasks": [
                {"id": "14.1", "title": "14.1 Infraestructura Base", "items": [
                    {"id": "14.1.1", "text": "Tabla `wallet_xcoin` en base de datos", "status": "âŒ"},
                    {"id": "14.1.2", "text": "Tabla `transacciones_xcoin` para historial", "status": "âŒ"},
                    {"id": "14.1.3", "text": "Sistema de balance y saldos", "status": "âŒ"},
                    {"id": "14.1.4", "text": "IntegraciÃ³n con sistema de afiliados (comisiones en XCOIN)", "status": "âŒ"},
                    {"id": "14.1.5", "text": "IntegraciÃ³n con sistema de pagos (depÃ³sitos)", "status": "âŒ"}
                ]},
                {"id": "14.2", "title": "14.2 Frontend - Ver Saldos", "items": [
                    {"id": "14.2.1", "text": "PÃ¡gina/componente de Wallet XCOIN", "status": "âŒ"},
                    {"id": "14.2.2", "text": "VisualizaciÃ³n de saldo actual", "status": "âŒ"},
                    {"id": "14.2.3", "text": "Historial de transacciones", "status": "âŒ"},
                    {"id": "14.2.4", "text": "Filtros por tipo de transacciÃ³n (depÃ³sito, retiro, comisiÃ³n, intercambio)", "status": "âŒ"},
                    {"id": "14.2.5", "text": "GrÃ¡ficos de movimientos", "status": "âŒ"},
                    {"id": "14.2.6", "text": "DiseÃ±o responsive y moderno", "status": "âŒ"}
                ]},
                {"id": "14.3", "title": "14.3 Frontend - Enviar XCOIN", "items": [
                    {"id": "14.3.1", "text": "Formulario de envÃ­o", "status": "âŒ"},
                    {"id": "14.3.2", "text": "ValidaciÃ³n de destinatario (email o cÃ³digo IB)", "status": "âŒ"},
                    {"id": "14.3.3", "text": "ValidaciÃ³n de saldo suficiente", "status": "âŒ"},
                    {"id": "14.3.4", "text": "ConfirmaciÃ³n de transacciÃ³n", "status": "âŒ"},
                    {"id": "14.3.5", "text": "NotificaciÃ³n al destinatario", "status": "âŒ"},
                    {"id": "14.3.6", "text": "Registro en historial", "status": "âŒ"}
                ]},
                {"id": "14.4", "title": "14.4 Frontend - Intercambiar XCOIN", "items": [
                    {"id": "14.4.1", "text": "Interfaz de intercambio", "status": "âŒ"},
                    {"id": "14.4.2", "text": "ConversiÃ³n XCOIN a USD/EUR/etc.", "status": "âŒ"},
                    {"id": "14.4.3", "text": "ConversiÃ³n de otras monedas a XCOIN", "status": "âŒ"},
                    {"id": "14.4.4", "text": "Tasas de cambio en tiempo real", "status": "âŒ"},
                    {"id": "14.4.5", "text": "ConfirmaciÃ³n de intercambio", "status": "âŒ"},
                    {"id": "14.4.6", "text": "Registro en historial", "status": "âŒ"}
                ]},
                {"id": "14.5", "title": "14.5 Frontend - Retirar XCOIN", "items": [
                    {"id": "14.5.1", "text": "Formulario de retiro", "status": "âŒ"},
                    {"id": "14.5.2", "text": "ValidaciÃ³n de monto mÃ­nimo", "status": "âŒ"},
                    {"id": "14.5.3", "text": "SelecciÃ³n de mÃ©todo de retiro (crypto, transferencia bancaria, etc.)", "status": "âŒ"},
                    {"id": "14.5.4", "text": "ValidaciÃ³n de datos de retiro", "status": "âŒ"},
                    {"id": "14.5.5", "text": "ConfirmaciÃ³n de solicitud", "status": "âŒ"},
                    {"id": "14.5.6", "text": "Estado de solicitud (pendiente, procesado, rechazado)", "status": "âŒ"},
                    {"id": "14.5.7", "text": "NotificaciÃ³n al admin para procesar retiro", "status": "âŒ"}
                ]},
                {"id": "14.6", "title": "14.6 Backend - APIs", "items": [
                    {"id": "14.6.1", "text": "Endpoint para obtener saldo de usuario", "status": "âŒ"},
                    {"id": "14.6.2", "text": "Endpoint para enviar XCOIN", "status": "âŒ"},
                    {"id": "14.6.3", "text": "Endpoint para intercambiar XCOIN", "status": "âŒ"},
                    {"id": "14.6.4", "text": "Endpoint para solicitar retiro", "status": "âŒ"},
                    {"id": "14.6.5", "text": "Endpoint para historial de transacciones", "status": "âŒ"},
                    {"id": "14.6.6", "text": "Endpoint admin para procesar retiros", "status": "âŒ"},
                    {"id": "14.6.7", "text": "Validaciones de seguridad y permisos", "status": "âŒ"}
                ]},
                {"id": "14.7", "title": "14.7 IntegraciÃ³n con Sistema de Afiliados", "items": [
                    {"id": "14.7.1", "text": "Asignar comisiones CPA en XCOIN automÃ¡ticamente", "status": "âŒ"},
                    {"id": "14.7.2", "text": "Notificar afiliado cuando recibe comisiÃ³n en XCOIN", "status": "âŒ"},
                    {"id": "14.7.3", "text": "Dashboard de afiliados muestra saldo XCOIN", "status": "âŒ"},
                    {"id": "14.7.4", "text": "OpciÃ³n de retirar comisiones en XCOIN", "status": "âŒ"}
                ]},
                {"id": "14.8", "title": "14.8 IntegraciÃ³n con Pagos", "items": [
                    {"id": "14.8.1", "text": "DepÃ³sitos desde Stripe se convierten a XCOIN (opcional)", "status": "âŒ"},
                    {"id": "14.8.2", "text": "DepÃ³sitos desde NOWPayments se convierten a XCOIN (opcional)", "status": "âŒ"},
                    {"id": "14.8.3", "text": "ConfiguraciÃ³n de tasa de conversiÃ³n", "status": "âŒ"},
                    {"id": "14.8.4", "text": "Historial de depÃ³sitos", "status": "âŒ"}
                ]},
                {"id": "14.9", "title": "14.9 Panel Admin - GestiÃ³n de Retiros", "items": [
                    {"id": "14.9.1", "text": "Lista de solicitudes de retiro pendientes", "status": "âŒ"},
                    {"id": "14.9.2", "text": "Detalles de cada solicitud", "status": "âŒ"},
                    {"id": "14.9.3", "text": "Procesar retiro (aprobar/rechazar)", "status": "âŒ"},
                    {"id": "14.9.4", "text": "Enviar email de confirmaciÃ³n al usuario", "status": "âŒ"},
                    {"id": "14.9.5", "text": "Actualizar estado de retiro", "status": "âŒ"},
                    {"id": "14.9.6", "text": "Historial completo de retiros procesados", "status": "âŒ"}
                ]}
            ]},
            { "id": "15", "title": "ðŸ§ª 15. PRUEBAS Y VERIFICACIONES", "tasks": [
                {"id": "15.1", "title": "15.1 Pruebas de Suscripciones", "items": [
                    {"id": "15.1.1", "text": "Probar creaciÃ³n de suscripciÃ³n", "status": "â³"},
                    {"id": "15.1.2", "text": "Probar activaciÃ³n automÃ¡tica desde webhook", "status": "â³"},
                    {"id": "15.1.3", "text": "Probar cancelaciÃ³n", "status": "â³"},
                    {"id": "15.1.4", "text": "Probar renovaciÃ³n", "status": "â³"},
                    {"id": "15.1.5", "text": "Probar restricciones de acceso", "status": "â³"}
                ]},
                {"id": "15.2", "title": "15.2 Pruebas de Pagos Stripe", "items": [
                    {"id": "15.2.1", "text": "Probar pago Ãºnico", "status": "â³"},
                    {"id": "15.2.2", "text": "Probar suscripciÃ³n recurrente", "status": "â³"},
                    {"id": "15.2.3", "text": "Probar webhook de eventos", "status": "â³"},
                    {"id": "15.2.4", "text": "Probar creaciÃ³n de ventas en BD", "status": "â³"},
                    {"id": "15.2.5", "text": "Probar asignaciÃ³n de comisiones de afiliados", "status": "â³"},
                    {"id": "15.2.6", "text": "Probar pÃ¡ginas de Ã©xito/error", "status": "â³"}
                ]},
                {"id": "15.3", "title": "15.3 Pruebas de Pagos Crypto", "items": [
                    {"id": "15.3.1", "text": "Probar pago con NOWPayments", "status": "â³"},
                    {"id": "15.3.2", "text": "Probar pago con CoinGate", "status": "â³"},
                    {"id": "15.3.3", "text": "Probar webhooks", "status": "â³"},
                    {"id": "15.3.4", "text": "Probar creaciÃ³n de ventas en BD", "status": "â³"},
                    {"id": "15.3.5", "text": "Probar asignaciÃ³n de comisiones", "status": "â³"}
                ]},
                {"id": "15.4", "title": "15.4 Pruebas de Sistema de Afiliados", "items": [
                    {"id": "15.4.1", "text": "Probar registro con tracking", "status": "â³"},
                    {"id": "15.4.2", "text": "Probar clicks en links de afiliado", "status": "â³"},
                    {"id": "15.4.3", "text": "Probar creaciÃ³n de leads", "status": "â³"},
                    {"id": "15.4.4", "text": "Probar asignaciÃ³n de comisiones multinivel", "status": "â³"},
                    {"id": "15.4.5", "text": "Probar notificaciones a afiliados", "status": "â³"},
                    {"id": "15.4.6", "text": "Probar retiros", "status": "â³"},
                    {"id": "15.4.7", "text": "Probar transferencias", "status": "â³"}
                ]},
                {"id": "15.5", "title": "15.5 Pruebas Generales", "items": [
                    {"id": "15.5.1", "text": "Probar flujo completo de registro â†’ compra â†’ comisiÃ³n", "status": "â³"},
                    {"id": "15.5.2", "text": "Probar restricciones por suscripciÃ³n en todos los mÃ³dulos", "status": "â³"},
                    {"id": "15.5.3", "text": "Probar sistema de notificaciones completo", "status": "â³"},
                    {"id": "15.5.4", "text": "Probar sistema de emails completo", "status": "â³"},
                    {"id": "15.5.5", "text": "Probar multi-tenant (mÃºltiples comunidades)", "status": "â³"}
                ]},
                {"id": "15.6", "title": "15.6 Pruebas E2E (End-to-End) - Flujo Completo", "items": [
                    {"id": "15.6.1", "text": "E2E-1: Registro con link de afiliado", "status": "âŒ"},
                    {"id": "15.6.2", "text": "E2E-2: AprobaciÃ³n FTD (First Time Deposit)", "status": "âŒ"},
                    {"id": "15.6.3", "text": "E2E-3: ComisiÃ³n CPA en XCOIN", "status": "âŒ"},
                    {"id": "15.6.4", "text": "E2E-4: Formulario MT4/MT5", "status": "âŒ"},
                    {"id": "15.6.5", "text": "E2E-5: ConexiÃ³n Manual y ActivaciÃ³n", "status": "âŒ"},
                    {"id": "15.6.6", "text": "E2E-6: Solicitud de Retiro de XCOIN", "status": "âŒ"},
                    {"id": "15.6.7", "text": "E2E-7: Procesamiento de Retiro por Admin", "status": "âŒ"}
                ]},
                {"id": "15.7", "title": "15.7 Pruebas E2E - Conectar Formularios y Botones", "items": [
                    {"id": "15.7.1", "text": "Full-Stack: Conectar formularios de compra", "status": "âŒ"},
                    {"id": "15.7.2", "text": "Full-Stack: Probar flujo de compra (Stripe)", "status": "âŒ"},
                    {"id": "15.7.3", "text": "Full-Stack: Probar flujo de depÃ³sito (NOWPayments)", "status": "âŒ"}
                ]}
            ]},
            { "id": "16", "title": "ðŸ“± 16. DESARROLLO DE APPS MÃ“VILES", "tasks": [
                {"id": "16.1", "title": "16.1 Infraestructura Base", "items": [
                    {"id": "16.1.1", "text": "Configurar proyecto React Native o Flutter", "status": "âŒ"},
                    {"id": "16.1.2", "text": "Configurar entorno de desarrollo (Android Studio, Xcode)", "status": "âŒ"},
                    {"id": "16.1.3", "text": "Configurar autenticaciÃ³n mÃ³vil (Supabase Auth)", "status": "âŒ"},
                    {"id": "16.1.4", "text": "Configurar API endpoints para mÃ³vil", "status": "âŒ"},
                    {"id": "16.1.5", "text": "Configurar push notifications mÃ³viles", "status": "âŒ"},
                    {"id": "16.1.6", "text": "Configurar deep linking", "status": "âŒ"}
                ]},
                {"id": "16.2", "title": "16.2 App Android", "items": [
                    {"id": "16.2.1", "text": "Estructura Base", "status": "âŒ"},
                    {"id": "16.2.2", "text": "AutenticaciÃ³n", "status": "âŒ"},
                    {"id": "16.2.3", "text": "NavegaciÃ³n Principal", "status": "âŒ"},
                    {"id": "16.2.4", "text": "Funcionalidades Core", "status": "âŒ"},
                    {"id": "16.2.5", "text": "Wallet XCOIN MÃ³vil", "status": "âŒ"},
                    {"id": "16.2.6", "text": "Sistema de Afiliados MÃ³vil", "status": "âŒ"},
                    {"id": "16.2.7", "text": "Pagos MÃ³vil", "status": "âŒ"},
                    {"id": "16.2.8", "text": "Optimizaciones Android", "status": "âŒ"}
                ]},
                {"id": "16.3", "title": "16.3 App iOS (Apple)", "items": [
                    {"id": "16.3.1", "text": "Estructura Base", "status": "âŒ"},
                    {"id": "16.3.2", "text": "AutenticaciÃ³n", "status": "âŒ"},
                    {"id": "16.3.3", "text": "NavegaciÃ³n Principal", "status": "âŒ"},
                    {"id": "16.3.4", "text": "Funcionalidades Core", "status": "âŒ"},
                    {"id": "16.3.5", "text": "Wallet XCOIN MÃ³vil", "status": "âŒ"},
                    {"id": "16.3.6", "text": "Sistema de Afiliados MÃ³vil", "status": "âŒ"},
                    {"id": "16.3.7", "text": "Pagos MÃ³vil", "status": "âŒ"},
                    {"id": "16.3.8", "text": "Optimizaciones iOS", "status": "âŒ"}
                ]},
                {"id": "16.4", "title": "16.4 Funcionalidades Compartidas (Android + iOS)", "items": [
                    {"id": "16.4.1", "text": "Offline Mode", "status": "âŒ"},
                    {"id": "16.4.2", "text": "Push Notifications", "status": "âŒ"},
                    {"id": "16.4.3", "text": "BiometrÃ­a", "status": "âŒ"},
                    {"id": "16.4.4", "text": "Compartir Contenido", "status": "âŒ"},
                    {"id": "16.4.5", "text": "BÃºsqueda", "status": "âŒ"}
                ]},
                {"id": "16.5", "title": "16.5 Testing y QA", "items": [
                    {"id": "16.5.1", "text": "Tests unitarios", "status": "âŒ"},
                    {"id": "16.5.2", "text": "Tests de integraciÃ³n", "status": "âŒ"},
                    {"id": "16.5.3", "text": "Tests E2E en dispositivos reales", "status": "âŒ"},
                    {"id": "16.5.4", "text": "Testing en diferentes versiones de Android/iOS", "status": "âŒ"},
                    {"id": "16.5.5", "text": "Testing en diferentes tamaÃ±os de pantalla", "status": "âŒ"},
                    {"id": "16.5.6", "text": "Testing de rendimiento", "status": "âŒ"},
                    {"id": "16.5.7", "text": "Testing de seguridad", "status": "âŒ"}
                ]},
                {"id": "16.6", "title": "16.6 Deployment", "items": [
                    {"id": "16.6.1", "text": "Android", "status": "âŒ"},
                    {"id": "16.6.2", "text": "iOS", "status": "âŒ"}
                ]},
                {"id": "16.7", "title": "16.7 Monitoreo y Analytics", "items": [
                    {"id": "16.7.1", "text": "Integrar Firebase Analytics", "status": "âŒ"},
                    {"id": "16.7.2", "text": "Integrar Crashlytics", "status": "âŒ"},
                    {"id": "16.7.3", "text": "Monitoreo de rendimiento", "status": "âŒ"},
                    {"id": "16.7.4", "text": "Tracking de eventos de usuario", "status": "âŒ"},
                    {"id": "16.7.5", "text": "Reportes de errores", "status": "âŒ"}
                ]}
            ]},
            { "id": "17", "title": "ðŸ› ï¸ 17. HERRAMIENTAS Y FUNCIONALIDADES ESPECIALES", "tasks": [
                {"id": "17.1", "title": "17.1 Alpha X100", "items": [
                    {"id": "17.1.1", "text": "Panel de administraciÃ³n", "status": "âœ…"},
                    {"id": "17.1.2", "text": "Sistema de tokens", "status": "âœ…"},
                    {"id": "17.1.3", "text": "Restricciones por suscripciÃ³n implementadas", "status": "âœ…"},
                    {"id": "17.1.4", "text": "Verificar que las restricciones funcionan correctamente", "status": "â³"}
                ]},
                {"id": "17.2", "title": "17.2 Trading Lab", "items": [
                    {"id": "17.2.1", "text": "Implementado", "status": "âœ…"},
                    {"id": "17.2.2", "text": "Agregar restricciones por suscripciÃ³n/niveles", "status": "â³"},
                    {"id": "17.2.3", "text": "Verificar funcionamiento", "status": "â³"}
                ]},
                {"id": "17.3", "title": "17.3 Crypto Health Scanner", "items": [
                    {"id": "17.3.1", "text": "Implementado", "status": "âœ…"},
                    {"id": "17.3.2", "text": "Agregar restricciones por suscripciÃ³n/niveles", "status": "â³"},
                    {"id": "17.3.3", "text": "Verificar funcionamiento", "status": "â³"}
                ]},
                {"id": "17.4", "title": "17.4 Otras Herramientas", "items": [
                    {"id": "17.4.1", "text": "Verificar que todas las herramientas funcionan correctamente", "status": "â³"},
                    {"id": "17.4.2", "text": "Agregar restricciones donde sea necesario", "status": "â³"},
                    {"id": "17.4.3", "text": "Optimizar rendimiento", "status": "â³"}
                ]}
            ]},
            { "id": "18", "title": "ðŸŒ 18. SISTEMA WHITE-LABEL", "tasks": [
                {"id": "18.1", "title": "18.1 Dominios Personalizados", "items": [
                    {"id": "18.1.1", "text": "Tabla `dominios_white_label`", "status": "âœ…"},
                    {"id": "18.1.2", "text": "API de verificaciÃ³n de nameservers", "status": "âœ…"},
                    {"id": "18.1.3", "text": "Panel admin para gestiÃ³n de dominios", "status": "âœ…"},
                    {"id": "18.1.4", "text": "Sistema de detecciÃ³n automÃ¡tica de comunidad por dominio", "status": "âœ…"},
                    {"id": "18.1.5", "text": "Mantener dominio en navegaciÃ³n despuÃ©s de detectarlo", "status": "â³"},
                    {"id": "18.1.6", "text": "Configurar SSL automÃ¡tico", "status": "â³"},
                    {"id": "18.1.7", "text": "Verificar que el sistema funciona correctamente", "status": "â³"}
                ]},
                {"id": "18.2", "title": "18.2 ConfiguraciÃ³n Multi-Tenant", "items": [
                    {"id": "18.2.1", "text": "Sistema de comunidades independientes", "status": "âœ…"},
                    {"id": "18.2.2", "text": "ConfiguraciÃ³n por comunidad", "status": "âœ…"},
                    {"id": "18.2.3", "text": "Completar migraciÃ³n de `community_id` en todas las tablas", "status": "â³"},
                    {"id": "18.2.4", "text": "Verificar aislamiento de datos entre comunidades", "status": "â³"}
                ]}
            ]},
            { "id": "19", "title": "ðŸ“Š 19. ANALYTICS Y REPORTES", "tasks": [
                {"id": "19.1", "title": "19.1 Dashboard de MÃ©tricas", "items": [
                    {"id": "19.1.1", "text": "EstadÃ­sticas bÃ¡sicas en paneles admin", "status": "âœ…"},
                    {"id": "19.1.2", "text": "Dashboard con grÃ¡ficos interactivos", "status": "â³"},
                    {"id": "19.1.3", "text": "Reportes personalizables", "status": "â³"},
                    {"id": "19.1.4", "text": "Exportar datos (CSV, PDF)", "status": "â³"},
                    {"id": "19.1.5", "text": "AnÃ¡lisis de cohortes", "status": "â³"}
                ]},
                {"id": "19.2", "title": "19.2 MÃ©tricas de Afiliados", "items": [
                    {"id": "19.2.1", "text": "Dashboard de afiliados con mÃ©tricas bÃ¡sicas", "status": "âœ…"},
                    {"id": "19.2.2", "text": "GrÃ¡ficos avanzados", "status": "â³"},
                    {"id": "19.2.3", "text": "Reportes detallados", "status": "â³"},
                    {"id": "19.2.4", "text": "Exportar reportes", "status": "â³"}
                ]}
            ]},
            { "id": "20", "title": "ðŸ› 20. ERRORES CONOCIDOS Y CORRECCIONES PENDIENTES", "tasks": [
                {"id": "20.1", "title": "20.1 Errores CrÃ­ticos", "items": [
                    {"id": "20.1.1", "text": "Registro no crea usuario en tabla usuarios", "status": "â³"},
                    {"id": "20.1.2", "text": "Sistema de afiliados no registra clicks ni leads", "status": "â³"},
                    {"id": "20.1.3", "text": "Ventas falsas automÃ¡ticas", "status": "â³"},
                    {"id": "20.1.4", "text": "Tracking incompleto", "status": "â³"},
                    {"id": "20.1.5", "text": "Botones de pago no funcionan", "status": "â³"}
                ]},
                {"id": "20.2", "title": "20.2 Errores de IntegraciÃ³n", "items": [
                    {"id": "20.2.1", "text": "Webhooks no crean ventas correctamente", "status": "â³"},
                    {"id": "20.2.2", "text": "Comisiones no se asignan automÃ¡ticamente", "status": "â³"},
                    {"id": "20.2.3", "text": "Notificaciones no se envÃ­an", "status": "â³"},
                    {"id": "20.2.4", "text": "Emails no se envÃ­an", "status": "â³"}
                ]},
                {"id": "20.3", "title": "20.3 Errores de UI/UX", "items": [
                    {"id": "20.3.1", "text": "Dominios white-label no se mantienen despuÃ©s de login", "status": "â³"},
                    {"id": "20.3.2", "text": "Restricciones no se muestran visualmente", "status": "â³"},
                    {"id": "20.3.3", "text": "Mensajes de error poco claros", "status": "â³"}
                ]}
            ]},
            { "id": "21", "title": "ðŸš€ 21. OPTIMIZACIONES Y MEJORAS", "tasks": [
                {"id": "21.1", "title": "21.1 Performance", "items": [
                    {"id": "21.1.1", "text": "Optimizar consultas SQL", "status": "â³"},
                    {"id": "21.1.2", "text": "Implementar caching", "status": "â³"},
                    {"id": "21.1.3", "text": "Optimizar carga de imÃ¡genes", "status": "â³"},
                    {"id": "21.1.4", "text": "Optimizar carga de componentes", "status": "â³"}
                ]},
                {"id": "21.2", "title": "21.2 CÃ³digo", "items": [
                    {"id": "21.2.1", "text": "Eliminar cÃ³digo duplicado", "status": "â³"},
                    {"id": "21.2.2", "text": "Mejorar manejo de errores", "status": "â³"},
                    {"id": "21.2.3", "text": "Agregar tests automatizados", "status": "â³"},
                    {"id": "21.2.4", "text": "Mejorar documentaciÃ³n del cÃ³digo", "status": "â³"}
                ]},
                {"id": "21.3", "title": "21.3 UX/UI", "items": [
                    {"id": "21.3.1", "text": "Mejorar mensajes de error", "status": "â³"},
                    {"id": "21.3.2", "text": "Agregar loading states", "status": "â³"},
                    {"id": "21.3.3", "text": "Mejorar feedback visual", "status": "â³"},
                    {"id": "21.3.4", "text": "Optimizar responsive design", "status": "â³"}
                ]}
            ]},
            { "id": "22", "title": "ðŸ“ 22. DOCUMENTACIÃ“N", "tasks": [
                {"id": "22.1", "title": "22.1 DocumentaciÃ³n TÃ©cnica", "items": [
                    {"id": "22.1.1", "text": "GuÃ­a de onboarding para desarrolladores", "status": "âœ…"},
                    {"id": "22.1.2", "text": "AnÃ¡lisis completo del proyecto", "status": "âœ…"},
                    {"id": "22.1.3", "text": "DocumentaciÃ³n de arquitectura", "status": "âœ…"},
                    {"id": "22.1.4", "text": "DocumentaciÃ³n de APIs", "status": "â³"},
                    {"id": "22.1.5", "text": "DocumentaciÃ³n de base de datos", "status": "â³"},
                    {"id": "22.1.6", "text": "Diagramas de flujo", "status": "â³"}
                ]},
                {"id": "22.2", "title": "22.2 DocumentaciÃ³n de Usuario", "items": [
                    {"id": "22.2.1", "text": "GuÃ­as de usuario", "status": "âŒ"},
                    {"id": "22.2.2", "text": "Tutoriales en video", "status": "âŒ"},
                    {"id": "22.2.3", "text": "FAQ interactivo", "status": "âŒ"},
                    {"id": "22.2.4", "text": "DocumentaciÃ³n de funcionalidades", "status": "âŒ"}
                ]}
            ]}
        ];

        // --- Funciones de InicializaciÃ³n ---

        async function startApp() {
            try {
                // 1. Inicializar Firebase
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    showMessage("Error: ConfiguraciÃ³n de Firebase incompleta.");
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                // --- LÃ“GICA DE LOGIN CON GOOGLE ---
                loadingText.textContent = "Verificando autenticaciÃ³n...";
                // Mostrar spinner y ocultar todo
                loadingSpinner.classList.remove('hidden');
                loginContainer.classList.add('hidden');
                mainAppContainer.classList.add('hidden');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Usuario estÃ¡ logueado
                        userId = user.uid;
                        console.log("Usuario conectado:", user.displayName, userId);
                        
                        // Mostrar estado en la app principal
                        authStatusMain.textContent = `Conectado: ${user.displayName}`;
                        authStatusMain.classList.remove('text-yellow-400');
                        authStatusMain.classList.add('text-green-400');
                        
                        // Ocultar login, mostrar app y spinner (mientras cargan datos)
                        loginContainer.classList.add('hidden');
                        mainAppContainer.classList.remove('hidden');
                        loadingSpinner.classList.remove('hidden'); // Spinner para datos
                        loadingText.textContent = "Cargando proyecto...";
                        
                        // 3. Una vez autenticado, configurar la referencia y escuchar cambios
                        setupFirestoreListener();
                    } else {
                        // Usuario no estÃ¡ logueado
                        console.log("Usuario no conectado.");
                        // Mostrar pantalla de login, ocultar app y spinner
                        loginContainer.classList.remove('hidden');
                        mainAppContainer.classList.add('hidden');
                        loadingSpinner.classList.add('hidden');
                        authStatusLogin.textContent = "Desconectado";
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showMessage(`Error al inicializar: ${error.message}`);
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- NUEVA: FunciÃ³n de Login con Google ---
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                loadingSpinner.classList.remove('hidden');
                loadingText.textContent = "Abriendo ventana de Google...";
                await signInWithPopup(auth, provider);
                // onAuthStateChanged se encargarÃ¡ del resto
            } catch (error) {
                console.error("Error al iniciar sesiÃ³n con Google:", error);
                // Si el error es por dominio no autorizado, da un mensaje claro
                if (error.code === 'auth/unauthorized-domain') {
                    showMessage("Error: Este dominio no estÃ¡ autorizado para iniciar sesiÃ³n. Debes aÃ±adirlo a la lista de 'Dominios autorizados' en tu consola de Firebase (Authentication -> Sign-in method).");
                } else {
                    showMessage(`Error al iniciar sesiÃ³n: ${error.message}`);
                }
                loadingSpinner.classList.add('hidden');
            }
        }


        // --- MODIFICADA: Vuelve a la versiÃ³n de UN SOLO PROYECTO ---
        function setupFirestoreListener() {
            try {
                // Esta es la ruta original de un solo proyecto
                const docPath = `artifacts/${appId}/public/data/projects/scalexone`;
                projectDocRef = doc(db, docPath);

                // Escuchar cambios en tiempo real para ESE proyecto
                onSnapshot(projectDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        projectData = JSON.parse(data.content || "[]");
                        priorityTasks = JSON.parse(data.priorities || "[]");
                        console.log("Datos cargados desde Firestore para el proyecto: scalexone");
                    } else {
                        // El documento no existe, crear con datos iniciales
                        console.log("El documento del proyecto no existe, creando uno nuevo...");
                        projectData = initialProjectData;
                        priorityTasks = [];
                        saveInitialData(); // GuardarÃ¡ en el projectDocRef actual
                    }
                    // Renderizar la UI con los datos
                    renderProject();
                    renderPriorityTasks();
                    loadingSpinner.classList.add('hidden');
                }, (error) => {
                    console.error("Error en onSnapshot (proyecto):", error);
                    showMessage(`Error al sincronizar datos: ${error.message}`);
                    loadingSpinner.classList.add('hidden');
                });
                
            } catch (error) {
                console.error("Error al configurar Firestore:", error);
                showMessage(`Error de configuraciÃ³n: ${error.message}`);
                loadingSpinner.classList.add('hidden');
            }
        }
        
        async function saveInitialData() {
            if (!projectDocRef) return;
            try {
                await setDoc(projectDocRef, {
                    projectName: "SCALEXONE", // AÃ±adir un nombre por defecto
                    content: JSON.stringify(projectData),
                    priorities: JSON.stringify(priorityTasks) 
                }, { merge: true });
                console.log("Proyecto inicial guardado.");
            } catch (error) {
                console.error("Error al guardar datos iniciales:", error);
                showMessage(`Error al guardar: ${error.message}`);
            }
        }

        function renderProject() {
            const projectContainer = document.getElementById('project-container');
            if (!projectContainer) return;
            savedScrollY = window.scrollY;
            projectContainer.innerHTML = ''; 

            if (projectData.length === 0) {
                projectContainer.innerHTML = '<p class="text-gray-400">Este proyecto estÃ¡ vacÃ­o. Los datos pueden estar cargando.</p>';
                return;
            }

            projectData.forEach(section => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden';
                
                const sectionHeader = document.createElement('h2');
                sectionHeader.className = 'text-2xl font-bold text-white p-4 bg-gray-800 border-b border-gray-700 accordion-header flex justify-between items-center';
                
                const sectionTitleDiv = document.createElement('div');
                const sectionArrow = document.createElement('span');
                sectionArrow.className = 'accordion-arrow';
                sectionArrow.textContent = 'â–¶';
                
                sectionTitleDiv.appendChild(sectionArrow);
                sectionTitleDiv.appendChild(document.createTextNode(section.title));
                sectionHeader.appendChild(sectionTitleDiv);

                const sectionHasNotes = section.tasks.some(sub => 
                    sub.items.some(item => item.note && item.note.trim() !== '')
                );
                if (sectionHasNotes) {
                    const noteIndicator = document.createElement('span');
                    noteIndicator.className = 'text-xl text-blue-400 mr-2';
                    noteIndicator.textContent = 'ðŸ’¬';
                    sectionHeader.appendChild(noteIndicator);
                }
                sectionEl.appendChild(sectionHeader);

                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'p-4 space-y-4';
                
                if (openAccordions.has(section.id)) {
                    tasksContainer.classList.remove('hidden');
                    sectionHeader.classList.add('open');
                    sectionArrow.textContent = 'â–¼';
                } else {
                    tasksContainer.classList.add('hidden');
                    sectionArrow.textContent = 'â–¶';
                }
                
                sectionHeader.onclick = () => {
                    sectionHeader.classList.toggle('open');
                    tasksContainer.classList.toggle('hidden');
                    sectionArrow.textContent = tasksContainer.classList.contains('hidden') ? 'â–¶' : 'â–¼';
                    
                    if (tasksContainer.classList.contains('hidden')) {
                        openAccordions.delete(section.id);
                    } else {
                        openAccordions.add(section.id);
                    }
                };

                section.tasks.forEach(subsection => {
                    const subsectionEl = document.createElement('div');
                    subsectionEl.className = 'pl-4 border-l-2 border-gray-700';
                    
                    const subsectionTitle = document.createElement('h3');
                    subsectionTitle.className = 'text-lg font-semibold text-blue-300 mb-2 accordion-header flex justify-between items-center p-2 rounded-md';
                    
                    const subsectionTitleDiv = document.createElement('div');
                    const subsectionArrow = document.createElement('span');
                    subsectionArrow.className = 'accordion-arrow';
                    subsectionArrow.textContent = 'â–¶';

                    subsectionTitleDiv.appendChild(subsectionArrow);
                    subsectionTitleDiv.appendChild(document.createTextNode(subsection.title));
                    subsectionTitle.appendChild(subsectionTitleDiv);

                    const subsectionHasNotes = subsection.items.some(item => item.note && item.note.trim() !== '');
                    if (subsectionHasNotes) {
                        const noteIndicator = document.createElement('span');
                        noteIndicator.className = 'text-lg text-blue-400 mr-2';
                        noteIndicator.textContent = 'ðŸ’¬';
                        subsectionTitle.appendChild(noteIndicator);
                    }
                    subsectionEl.appendChild(subsectionTitle);

                    const itemsList = document.createElement('ul');
                    itemsList.className = 'space-y-2 pl-6';

                    if (openAccordions.has(subsection.id)) {
                        itemsList.classList.remove('hidden');
                        subsectionTitle.classList.add('open');
                        subsectionArrow.textContent = 'â–¼';
                    } else {
                        itemsList.classList.add('hidden');
                        subsectionArrow.textContent = 'â–¶';
                    }

                    subsectionTitle.onclick = (e) => {
                        e.stopPropagation();
                        subsectionTitle.classList.toggle('open');
                        itemsList.classList.toggle('hidden');
                        subsectionArrow.textContent = itemsList.classList.contains('hidden') ? 'â–¶' : 'â–¼';
                        
                        if (itemsList.classList.contains('hidden')) {
                            openAccordions.delete(subsection.id);
                        } else {
                            openAccordions.add(subsection.id);
                        }
                    };

                    subsection.items.forEach(item => {
                        const itemEl = document.createElement('li');
                        itemEl.className = 'block p-2 rounded-md hover:bg-gray-700 transition-colors duration-150 task-item';
                        itemEl.dataset.status = item.status;

                        const mainItemRow = document.createElement('div');
                        mainItemRow.className = 'flex items-center justify-between';

                        const itemContent = document.createElement('div');
                        itemContent.className = 'flex items-center flex-grow min-w-0';

                        const statusIcon = document.createElement('span');
                        statusIcon.className = 'status-icon cursor-pointer text-xl mr-3';
                        statusIcon.textContent = item.status;
                        statusIcon.dataset.sectionId = section.id;
                        statusIcon.dataset.subsectionId = subsection.id;
                        statusIcon.dataset.itemId = item.id;
                        statusIcon.onclick = handleStatusClick;

                        const itemText = document.createElement('span');
                        itemText.className = 'flex-grow truncate';
                        itemText.textContent = item.text;

                        itemContent.appendChild(statusIcon);
                        itemContent.appendChild(itemText);

                        const noteIcon = document.createElement('span');
                        noteIcon.className = 'note-icon cursor-pointer text-lg ml-3 text-gray-500 hover:text-blue-400 flex-shrink-0';
                        noteIcon.textContent = 'ðŸ’¬';
                        noteIcon.dataset.sectionId = section.id;
                        noteIcon.dataset.subsectionId = subsection.id;
                        noteIcon.dataset.itemId = item.id;
                        noteIcon.onclick = handleNoteClick;

                        mainItemRow.appendChild(itemContent);
                        mainItemRow.appendChild(noteIcon);
                        
                        itemEl.appendChild(mainItemRow);

                        if (item.note && item.note.trim() !== '') {
                            const noteContent = document.createElement('div');
                            noteContent.className = 'note-display p-2 mt-2 ml-10 bg-gray-700 rounded-md text-sm text-gray-300';
                            noteContent.innerHTML = linkify(item.note);

                            noteContent.classList.add('cursor-pointer', 'hover:bg-gray-600', 'transition-colors');
                            noteContent.dataset.sectionId = section.id;
                            noteContent.dataset.subsectionId = subsection.id;
                            noteContent.dataset.itemId = item.id;
                            noteContent.onclick = handleNoteClick;
                            
                            itemEl.appendChild(noteContent);
                            noteIcon.classList.add('has-note');
                        } else {
                            noteIcon.classList.remove('has-note');
                        }
                        itemsList.appendChild(itemEl);
                    });

                    subsectionEl.appendChild(itemsList);
                    tasksContainer.appendChild(subsectionEl);
                });

                sectionEl.appendChild(tasksContainer);
                projectContainer.appendChild(sectionEl);
            });
            
            requestAnimationFrame(() => {
                window.scrollTo(0, savedScrollY);
            });
        }

        function renderPriorityTasks() {
            const priorityListEl = document.getElementById('priority-list');
            if (!priorityListEl) return;
            
            priorityListEl.innerHTML = '';
            
            if (priorityTasks.length === 0) {
                priorityListEl.innerHTML = '<li class="text-gray-500 italic">No hay tareas prioritarias.</li>';
                return;
            }

            priorityTasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'block p-2 rounded-md hover:bg-gray-700 transition-colors duration-150 task-item';
                li.dataset.status = task.status;

                const mainItemRow = document.createElement('div');
                mainItemRow.className = 'flex items-center justify-between';

                const itemContent = document.createElement('div');
                itemContent.className = 'flex items-center flex-grow min-w-0';

                const statusIcon = document.createElement('span');
                statusIcon.className = 'status-icon cursor-pointer text-xl mr-3';
                statusIcon.textContent = task.status;
                statusIcon.dataset.index = index;
                statusIcon.onclick = handlePriorityStatusClick;

                const itemText = document.createElement('span');
                itemText.className = 'flex-grow truncate';
                itemText.textContent = task.text;

                itemContent.appendChild(statusIcon);
                itemContent.appendChild(itemText);
                mainItemRow.appendChild(itemContent);

                const itemControls = document.createElement('div');
                itemControls.className = 'flex items-center flex-shrink-0 ml-3';

                const noteIcon = document.createElement('span');
                noteIcon.className = 'note-icon cursor-pointer text-lg text-gray-500 hover:text-blue-400';
                noteIcon.textContent = 'ðŸ’¬';
                noteIcon.dataset.index = index;
                noteIcon.onclick = handlePriorityNoteClick;
                itemControls.appendChild(noteIcon);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 hover:text-red-500 text-2xl font-bold ml-3 px-2';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.dataset.index = index;
                deleteBtn.onclick = handleDeletePriority;
                itemControls.appendChild(deleteBtn);
                
                mainItemRow.appendChild(itemControls);
                li.appendChild(mainItemRow);

                if (task.note && task.note.trim() !== '') {
                    const noteContent = document.createElement('div');
                    noteContent.className = 'note-display p-2 mt-2 ml-10 bg-gray-700 rounded-md text-sm text-gray-300';
                    noteContent.innerHTML = linkify(task.note);

                    noteContent.classList.add('cursor-pointer', 'hover:bg-gray-600', 'transition-colors');
                    noteContent.dataset.index = index;
                    noteContent.onclick = handlePriorityNoteClick;
                    
                    li.appendChild(noteContent);
                    noteIcon.classList.add('has-note');
                } else {
                    noteIcon.classList.remove('has-note');
                }

                priorityListEl.appendChild(li);
            });
        }
        
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(-5px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in { animation: fade-in 0.3s ease-out; }
        `;
        document.head.appendChild(styleSheet);

        function handleStatusClick(event) {
            const { sectionId, subsectionId, itemId } = event.currentTarget.dataset;
            
            const item = findItem({ sectionId, subsectionId, itemId });
            if (!item) return;

            switch (item.status) {
                case 'âŒ': item.status = 'â³'; break;
                case 'â³': item.status = 'âœ…'; break;
                case 'âœ…': item.status = 'âŒ'; break;
                default: item.status = 'âŒ';
            }
            saveCoreProjectData();
        }
        
        function handleNoteClick(event) {
            event.stopPropagation();
            const { sectionId, subsectionId, itemId } = event.currentTarget.dataset;
            
            currentEditingItem = { sectionId, subsectionId, itemId };
            
            const item = findItem(currentEditingItem);
            if (item) {
                noteTextarea.value = item.note || '';
                noteModal.classList.remove('hidden');
            }
        }

        function saveNote() {
            if (!currentEditingItem && currentEditingPriorityItemIndex === null) return;

            if (currentEditingPriorityItemIndex !== null) {
                const index = currentEditingPriorityItemIndex;
                if (priorityTasks[index]) {
                    priorityTasks[index].note = noteTextarea.value;
                    savePriorityTasks();
                }
            } 
            else if (currentEditingItem) {
                const item = findItem(currentEditingItem);
                if (item) {
                    item.note = noteTextarea.value;
                    saveCoreProjectData();
                }
            }
            
            hideNoteModal();
        }

        function hideNoteModal() {
            noteModal.classList.add('hidden');
            currentEditingItem = null;
            currentEditingPriorityItemIndex = null;
            noteTextarea.value = '';
        }

        function findItem({ sectionId, subsectionId, itemId }) {
            const section = projectData.find(s => s.id === sectionId);
            if (!section) return null;
            const subsection = section.tasks.find(s => s.id === subsectionId);
            if (!subsection) return null;
            return subsection.items.find(i => i.id === itemId);
        }

        async function saveCoreProjectData() {
            if (!projectDocRef) return;
            try {
                await setDoc(projectDocRef, { content: JSON.stringify(projectData) }, { merge: true });
                console.log("Proyecto guardado en Firestore.");
            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
                showMessage(`Error al guardar: ${error.message}`);
            }
        }
        
        function handleAddPriority() {
            const input = document.getElementById('priority-input');
            const text = input.value.trim();
            if (text === '') return;
            
            priorityTasks.push({ 
                id: crypto.randomUUID(), 
                text: text,
                status: 'âŒ',
                note: ''
            });
            input.value = '';
            
            savePriorityTasks(); 
        }

        function handleDeletePriority(event) {
            try {
                const index = parseInt(event.currentTarget.dataset.index, 10);
                if (isNaN(index) || index < 0 || index >= priorityTasks.length) {
                    console.error("Ãndice de prioridad invÃ¡lido:", event.currentTarget.dataset.index);
                    return;
                }
                
                priorityTasks.splice(index, 1);
                
                savePriorityTasks();
            } catch (error) {
                console.error("Error al eliminar prioridad:", error);
                showMessage("Error al eliminar la tarea.");
            }
        }

        async function savePriorityTasks() {
            if (!projectDocRef) return;
            try {
                await setDoc(projectDocRef, { priorities: JSON.stringify(priorityTasks) }, { merge: true });
                console.log("Prioridades guardadas en Firestore.");
            } catch (error) {
                console.error("Error al guardar prioridades en Firestore:", error);
                showMessage(`Error al guardar prioridades: ${error.message}`);
            }
        }
        
        function handlePriorityStatusClick(event) {
            event.stopPropagation();
            const index = parseInt(event.currentTarget.dataset.index, 10);
            if (isNaN(index) || !priorityTasks[index]) return;

            const task = priorityTasks[index];
            
            switch (task.status) {
                case 'âŒ': task.status = 'â³'; break;
                case 'â³': task.status = 'âœ…'; break;
                case 'âœ…': task.status = 'âŒ'; break;
                default: task.status = 'âŒ';
            }
            savePriorityTasks();
        }

        function handlePriorityNoteClick(event) {
            event.stopPropagation();
            const index = parseInt(event.currentTarget.dataset.index, 10);
            if (isNaN(index) || !priorityTasks[index]) return;

            currentEditingPriorityItemIndex = index;
            currentEditingItem = null;
            
            const task = priorityTasks[index];
            noteTextarea.value = task.note || '';
            noteModal.classList.remove('hidden');
        }

        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');

        function showMessage(message) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function hideMessage() {
            messageModal.classList.add('hidden');
        }
        
        function linkify(text) {
            if (!text) return '';
            
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            
            const escapedText = document.createElement('div').appendChild(document.createTextNode(text)).parentNode.innerHTML;

            return escapedText.replace(urlRegex, function(url, match1, protocol, match2) {
                let fullUrl = url;
                if (match2) {
                    fullUrl = 'http://' + url; // <-- CORREGIDO AQUÃ
                }
                return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            }).replace(/\n/g, '<br>');
        }

        window.hideMessage = hideMessage;

        // --- Iniciar la aplicaciÃ³n ---
        startApp();

        // --- Asignar Eventos a Botones ---
        saveNoteBtn.onclick = saveNote;
        cancelNoteBtn.onclick = hideNoteModal;
        googleLoginBtn.onclick = handleGoogleLogin; // Asignar evento al botÃ³n de login

        document.getElementById('add-priority-btn').onclick = handleAddPriority;
        window.handleDeletePriority = handleDeletePriority;
        window.handlePriorityStatusClick = handlePriorityStatusClick;
        window.handlePriorityNoteClick = handlePriorityNoteClick;

    </script>
</body>
</html>