<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas - SCALEXONE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .task-item[data-status="‚úÖ"] span {
            text-decoration: line-through;
            color: #6b7280; /* text-gray-500 */
        }
        .status-icon {
            transition: transform 0.1s ease-in-out;
        }
        .status-icon:hover {
            transform: scale(1.2);
        }
        .note-icon {
            transition: transform 0.1s ease-in-out, color 0.1s ease-in-out;
        }
        .note-icon:hover {
            transform: scale(1.2);
        }
        .note-icon.has-note {
            color: #60a5fa; /* text-blue-400 */
        }
        .note-display {
            white-space: pre-wrap; /* Mantiene saltos de l√≠nea y espacios */
            word-break: break-word; /* Evita que los links largos rompan el layout */
        }
        .note-display a {
            color: #60a5fa; /* text-blue-400 */
            text-decoration: underline;
        }
        .note-display a:hover {
            color: #93c5fd; /* text-blue-300 */
        }
        /* Estilos para el acorde√≥n */
        .accordion-header {
            cursor: pointer;
            transition: background-color 0.2s ease-out;
        }
        .accordion-header:hover {
            background-color: #374151; /* bg-gray-700 */
        }
        .accordion-arrow {
            display: inline-block;
            transition: transform 0.2s ease-out;
            margin-right: 0.5rem;
            font-size: 0.8em;
            width: 1.5rem; /* Ancho fijo para alinear */
        }
        .accordion-header.open .accordion-arrow {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Pantalla de Login (Oculta si ya est√° logueado) -->
    <div id="login-container" class="hidden flex items-center justify-center min-h-screen">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <h1 class="text-3xl font-bold text-white mb-6">üìã Gestor de Proyectos</h1>
            <p class="text-gray-400 mb-8">Por favor, inicia sesi√≥n para continuar.</p>
            <button id="google-login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full flex items-center justify-center">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l0.001-0.001l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Iniciar sesi√≥n con Google
            </button>
            <div class="text-sm text-gray-400 mt-6">
                Estado: <span id="auth-status-login" class="font-semibold text-yellow-400">Desconectado</span>
            </div>
        </div>
    </div>


    <!-- Contenedor Principal de la App (Oculto al inicio) -->
    <div id="main-app-container" class="hidden">
        <!-- Contenedor Principal -->
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-700">
                <div class="flex flex-col md:flex-row items-center gap-4 mb-2 md:mb-0 w-full">
                    <h1 class="text-3xl font-bold text-white">üìã Gestor de Proyectos</h1>
                    <!-- Selector de Proyecto -->
                    <div class="flex items-center gap-2">
                        <label class="text-gray-300 text-sm font-semibold">Proyecto:</label>
                        <select id="project-selector" class="bg-blue-700 text-white px-4 py-2 rounded-lg border border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer font-semibold">
                            <option value="">Cargando proyectos...</option>
                        </select>
                        <button id="new-project-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                            + Nuevo Proyecto
                        </button>
                        <button id="delete-project-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm hidden">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
                <div class="text-sm text-gray-400">
                    Estado: <span id="auth-status-main" class="font-semibold text-green-400">Conectado</span>
                </div>
            </header>

            <!-- Contenedor del Proyecto -->
            <div id="project-container" class="space-y-6">
                <!-- El contenido se generar√° aqu√≠ -->
            </div>
            
            <!-- Bot√≥n para agregar Espacio de Trabajo -->
            <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-4">
                <button id="add-workspace-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                    + Agregar Espacio de Trabajo
                </button>
            </div>
        </div>

        <!-- Secci√≥n de Tareas Prioritarias -->
        <div class="container mx-auto p-4 md:p-8 max-w-7xl mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">üéØ Tareas Prioritarias</h2>
            <div class="bg-gray-800 rounded-lg shadow-md p-4">
                <ul id="priority-list" class="space-y-2 mb-4">
                    <li class="text-gray-500 italic">Cargando tareas prioritarias...</li>
                </ul>
                <div class="flex">
                    <input id="priority-input" type="text" class="flex-grow p-2 rounded-l-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="A√±adir nueva tarea prioritaria...">
                    <button id="add-priority-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-md">
                        A√±adir
                    </button>
                </div>
            </div>
        </div>
        <!-- Fin de Tareas Prioritarias -->
    </div>

    <!-- Indicador de Carga Global (Oculto al inicio) -->
    <div id="loading-spinner" class="hidden fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="mt-2 text-lg font-medium text-white">Conectando...</span>
        </div>
    </div>

    <!-- Modal de Mensajes/Errores -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p id="message-text" class="text-lg text-white mb-4">Mensaje</p>
            <button onclick="hideMessage()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                Entendido
            </button>
        </div>
    </div>

    <!-- Modal de Notas -->
    <div id="note-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg mx-auto w-full">
            <h3 class="text-xl font-semibold text-white mb-4">A√±adir/Editar Nota</h3>
            <textarea id="note-textarea" rows="5" class="w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-note-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg">
                    Cancelar
                </button>
                <button id="save-note-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">
                    Guardar Nota
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Nuevo Proyecto -->
    <div id="new-project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md mx-auto w-full">
            <h3 class="text-xl font-semibold text-white mb-4">üìÅ Crear Nuevo Proyecto</h3>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Nombre del Proyecto</label>
                <input id="new-project-name" type="text" class="w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: SCALEXONE, Marketing Q1">
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Descripci√≥n (opcional)</label>
                <textarea id="new-project-description" rows="3" class="w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Descripci√≥n del proyecto"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-new-project-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg">
                    Cancelar
                </button>
                <button id="create-project-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg">
                    Crear Proyecto
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Nuevo Espacio de Trabajo -->
    <div id="new-workspace-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md mx-auto w-full">
            <h3 class="text-xl font-semibold text-white mb-4">üü£ Crear Nuevo Espacio de Trabajo</h3>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">T√≠tulo del Espacio de Trabajo</label>
                <input id="new-workspace-title" type="text" class="w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ej: 1. INFRAESTRUCTURA BASE">
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-new-workspace-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg">
                    Cancelar
                </button>
                <button id="create-workspace-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg">
                    Crear Espacio
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Nuevo Grupo de Tareas -->
    <div id="new-taskgroup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md mx-auto w-full">
            <h3 class="text-xl font-semibold text-white mb-4">üîµ Crear Nuevo Grupo de Tareas</h3>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">T√≠tulo del Grupo de Tareas</label>
                <input id="new-taskgroup-title" type="text" class="w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 1.1 Autenticaci√≥n y Usuarios">
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-new-taskgroup-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg">
                    Cancelar
                </button>
                <button id="create-taskgroup-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">
                    Crear Grupo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Nueva Tarea -->
    <div id="new-task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md mx-auto w-full">
            <h3 class="text-xl font-semibold text-white mb-4">‚úÖ Crear Nueva Tarea</h3>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Descripci√≥n de la Tarea</label>
                <input id="new-task-text" type="text" class="w-full p-2 rounded-md bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ej: Implementar login con Google OAuth">
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-new-task-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg">
                    Cancelar
                </button>
                <button id="create-task-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg">
                    Crear Tarea
                </button>
            </div>
        </div>
    </div>

    <!-- Script de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,     // <-- REQUERIDO
            signInWithPopup       // <-- REQUERIDO
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            collection,
            getDocs,
            query,
            deleteDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuraci√≥n y Variables Globales ---
        const firebaseConfig = {
            apiKey: "AIzaSyAk9eA_iMIs8vQza199Hp_EIvVm7ughIFQ",
            authDomain: "organizador--scalex.firebaseapp.com",
            projectId: "organizador--scalex",
            storageBucket: "organizador--scalex.firebasestorage.app",
            messagingSenderId: "69457091494",
            appId: "1:69457091494:web:e9c4224f03311e75e48d67",
            measurementId: "G-R549Q9R2EN"
        };
        
        const appId = firebaseConfig.projectId || 'default-scalexone-app';

        let db, auth;
        let userId = null;
        let projectDocRef = null; 
        let currentProjectId = null; // ID del proyecto actualmente seleccionado
        let projectsListRef = null; // Referencia a la colecci√≥n de proyectos
        
        let projectData = []; 
        let priorityTasks = []; 
        let openAccordions = new Set(); 
        let savedScrollY = 0; 
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.getElementById('loading-text');
        
        // --- Elementos de UI ---
        const loginContainer = document.getElementById('login-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const authStatusLogin = document.getElementById('auth-status-login');
        const authStatusMain = document.getElementById('auth-status-main');
        const projectSelector = document.getElementById('project-selector');
        const newProjectBtn = document.getElementById('new-project-btn');
        const deleteProjectBtn = document.getElementById('delete-project-btn');
        const addWorkspaceBtn = document.getElementById('add-workspace-btn');

        // --- Elementos de Modales ---
        const noteModal = document.getElementById('note-modal');
        const noteTextarea = document.getElementById('note-textarea');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const cancelNoteBtn = document.getElementById('cancel-note-btn');
        const newProjectModal = document.getElementById('new-project-modal');
        const newProjectNameInput = document.getElementById('new-project-name');
        const newProjectDescriptionInput = document.getElementById('new-project-description');
        const createProjectBtn = document.getElementById('create-project-btn');
        const cancelNewProjectBtn = document.getElementById('cancel-new-project-btn');
        const newWorkspaceModal = document.getElementById('new-workspace-modal');
        const newWorkspaceTitleInput = document.getElementById('new-workspace-title');
        const createWorkspaceBtn = document.getElementById('create-workspace-btn');
        const cancelNewWorkspaceBtn = document.getElementById('cancel-new-workspace-btn');
        const newTaskgroupModal = document.getElementById('new-taskgroup-modal');
        const newTaskgroupTitleInput = document.getElementById('new-taskgroup-title');
        const createTaskgroupBtn = document.getElementById('create-taskgroup-btn');
        const cancelNewTaskgroupBtn = document.getElementById('cancel-new-taskgroup-btn');
        const newTaskModal = document.getElementById('new-task-modal');
        const newTaskTextInput = document.getElementById('new-task-text');
        const createTaskBtn = document.getElementById('create-task-btn');
        const cancelNewTaskBtn = document.getElementById('cancel-new-task-btn');
        let currentEditingItem = null;
        let currentEditingPriorityItemIndex = null;
        let currentWorkspaceIdForTaskgroup = null; // Para saber en qu√© espacio agregar el grupo
        let currentSectionIdForTask = null; // Para saber en qu√© espacio agregar la tarea
        let currentSubsectionIdForTask = null; // Para saber en qu√© grupo agregar la tarea

        // --- Datos Iniciales (Plantilla para nuevos proyectos) ---
        const initialProjectData = [
            { "id": "1", "title": "üèóÔ∏è 1. INFRAESTRUCTURA BASE", "tasks": [
                {"id": "1.1", "title": "1.1 Autenticaci√≥n y Usuarios", "items": [
                    {"id": "1.1.1", "text": "Sistema de registro/login con Supabase Auth", "status": "‚úÖ"},
                    {"id": "1.1.2", "text": "Soporte para Email y Google OAuth", "status": "‚úÖ"},
                    {"id": "1.1.3", "text": "Gesti√≥n de perfiles de usuario", "status": "‚úÖ"},
                    {"id": "1.1.4", "text": "Sistema de roles (admin, moderador, usuario, superadmin, owner)", "status": "‚úÖ"},
                    {"id": "1.1.5", "text": "Pol√≠ticas RLS (Row Level Security) configuradas", "status": "‚úÖ"},
                    {"id": "1.1.6", "text": "Verificar que el registro crea correctamente usuarios en tabla `usuarios`", "status": "‚è≥"},
                    {"id": "1.1.7", "text": "Corregir asignaci√≥n de `afiliado_referente` en registro", "status": "‚è≥"}
                ]},
                {"id": "1.2", "title": "1.2 Base de Datos", "items": [
                    {"id": "1.2.1", "text": "Tabla `usuarios` con campos completos", "status": "‚úÖ"},
                    {"id": "1.2.2", "text": "Tabla `comunidades` para gesti√≥n multi-tenant", "status": "‚úÖ"},
                    {"id": "1.2.3", "text": "Tabla `canales` para organizaci√≥n de contenido", "status": "‚úÖ"},
                    {"id": "1.2.4", "text": "Sistema de relaciones normalizadas", "status": "‚úÖ"},
                    {"id": "1.2.5", "text": "Vistas y funciones SQL optimizadas", "status": "‚úÖ"},
                    {"id": "1.2.6", "text": "Unificar `community_id` en todas las tablas (migraci√≥n pendiente)", "status": "‚è≥"}
                ]},
                {"id": "1.3", "title": "1.3 Deployment y Hosting", "items": [
                    {"id": "1.3.1", "text": "Frontend deployado en Vercel", "status": "‚úÖ"},
                    {"id": "1.3.2", "text": "Base de datos en Supabase", "status": "‚úÖ"},
                    {"id": "1.3.3", "text": "Storage para archivos en Supabase", "status": "‚úÖ"},
                    {"id": "1.3.4", "text": "Configuraci√≥n de variables de entorno", "status": "‚úÖ"},
                    {"id": "1.3.5", "text": "Microservicio Stripe en stripe.scalexone.app", "status": "‚úÖ"}
                ]}
            ]},
            { "id": "2", "title": "üé® 2. FRONTEND Y UX", "tasks": [
                {"id": "2.1", "title": "2.1 Navegaci√≥n y Layout", "items": [
                    {"id": "2.1.1", "text": "Sistema de rutas con React Router", "status": "‚úÖ"},
                    {"id": "2.1.2", "text": "Navbar responsive (ScrollNavbar, SecondNavbar)", "status": "‚úÖ"},
                    {"id": "2.1.3", "text": "Sidebar colapsable", "status": "‚úÖ"},
                    {"id": "2.1.4", "text": "Topbar con notificaciones", "status": "‚úÖ"},
                    {"id": "2.1.5", "text": "Footer", "status": "‚úÖ"},
                    {"id": "2.1.6", "text": "Sistema de men√∫s din√°micos por comunidad", "status": "‚úÖ"},
                    {"id": "2.1.7", "text": "Men√∫ secundario visible en todas las p√°ginas", "status": "‚úÖ"}
                ]},
                {"id": "2.2", "title": "2.2 P√°ginas Principales", "items": [
                    {"id": "2.2.1", "text": "P√°gina de inicio (Hero)", "status": "‚úÖ"},
                    {"id": "2.2.2", "text": "Dashboard principal", "status": "‚úÖ"},
                    {"id": "2.2.3", "text": "Classroom (gesti√≥n de cursos y m√≥dulos)", "status": "‚úÖ"},
                    {"id": "2.2.4", "text": "Comunidad (foros y canales)", "status": "‚úÖ"},
                    {"id": "2.2.5", "text": "Chat en tiempo real", "status": "‚úÖ"},
                    {"id": "2.2.6", "text": "P√°gina About", "status": "‚úÖ"},
                    {"id": "2.2.7", "text": "Marketplace p√∫blico", "status": "‚úÖ"},
                    {"id": "2.2.8", "text": "Launchpad (sistema de eventos)", "status": "‚úÖ"}
                ]},
                {"id": "2.3", "title": "2.3 Componentes Reutilizables", "items": [
                    {"id": "2.3.1", "text": "Botones personalizados", "status": "‚úÖ"},
                    {"id":"2.3.2", "text": "Modales", "status": "‚úÖ"},
                    {"id": "2.3.3", "text": "Forms con validaci√≥n", "status": "‚úÖ"},
                    {"id": "2.3.4", "text": "Tarjetas de productos", "status": "‚úÖ"},
                    {"id": "2.3.5", "text": "Sistema de iconos", "status": "‚úÖ"},
                    {"id": "2.3.6", "text": "Spinners de carga", "status": "‚úÖ"}
                ]}
            ]},
            { "id": "3", "title": "üõí 3. MARKETPLACE", "tasks": [
                {"id": "3.1", "title": "3.1 Cursos Marketplace", "items": [
                    {"id": "3.1.1", "text": "Tabla `cursos_marketplace`", "status": "‚úÖ"},
                    {"id": "3.1.2", "text": "CRUD completo desde panel admin", "status": "‚úÖ"},
                    {"id": "3.1.3", "text": "Subida de im√°genes", "status": "‚úÖ"},
                    {"id": "3.1.4", "text": "Categorizaci√≥n y filtros", "status": "‚úÖ"},
                    {"id": "3.1.5", "text": "Vista p√∫blica responsive", "status": "‚úÖ"},
                    {"id": "3.1.6", "text": "Integraci√≥n con sistema de suscripciones", "status": "‚úÖ"},
                    {"id": "3.1.7", "text": "Agregar campo `stripe_price_id` a tabla", "status": "‚è≥"},
                    {"id": "3.1.8", "text": "Crear producto en Stripe autom√°ticamente al guardar curso", "status": "‚è≥"}
                ]},
                {"id": "3.2", "title": "3.2 Servicios Marketplace", "items": [
                    {"id": "3.2.1", "text": "Tabla `servicios_marketplace`", "status": "‚úÖ"},
                    {"id": "3.2.2", "text": "Soporte para pago √∫nico y suscripci√≥n", "status": "‚úÖ"},
                    {"id": "3.2.3", "text": "CRUD completo", "status": "‚úÖ"},
                    {"id": "3.2.4", "text": "Badges informativos (Pago √önico / Suscripci√≥n)", "status": "‚úÖ"},
                    {"id": "3.2.5", "text": "Filtros inteligentes por categor√≠a", "status": "‚úÖ"},
                    {"id": "3.2.6", "text": "Vista p√∫blica con dise√±o premium", "status": "‚úÖ"},
                    {"id": "3.2.7", "text": "Funcionalidad de edici√≥n completa", "status": "‚úÖ"},
                    {"id": "3.2.8", "text": "Agregar campo `stripe_price_id` a tabla", "status": "‚è≥"},
                    {"id": "3.2.9", "text": "Crear producto en Stripe autom√°ticamente al guardar servicio", "status": "‚è≥"}
                ]},
                {"id": "3.3", "title": "3.3 Funcionalidades Marketplace", "items": [
                    {"id": "3.3.1", "text": "Filtros clickeables (Cursos, Servicios, Software/SaaS, Productos, Propiedades)", "status": "‚úÖ"},
                    {"id": "3.3.2", "text": "B√∫squeda por t√≠tulo y descripci√≥n", "status": "‚úÖ"},
                    {"id": "3.3.3", "text": "Estad√≠sticas en tiempo real", "status": "‚úÖ"},
                    {"id": "3.3.4", "text": "Dise√±o tipo Netflix horizontal", "status": "‚úÖ"},
                    {"id": "3.3.5", "text": "Colores diferenciados (dorado cursos, p√∫rpura servicios)", "status": "‚úÖ"}
                ]}
            ]},
            { "id": "4", "title": "üë• 4. SISTEMA DE COMUNIDAD", "tasks": [
                {"id": "4.1", "title": "4.1 Canales", "items": [
                    {"id": "4.1.1", "text": "Tabla `canales` con sistema de jerarqu√≠a", "status": "‚úÖ"},
                    {"id": "4.1.2", "text": "Panel admin con drag & drop para reordenamiento", "status": "‚úÖ"},
                    {"id": "4.1.3", "text": "Canales predefinidos (#Presentate, #Chat General, #CANAL VIP)", "status": "‚úÖ"},
                    {"id": "4.1.4", "text": "Permisos por canal", "status": "‚úÖ"},
                    {"id": "4.1.5", "text": "Sistema de mensajer√≠a", "status": "‚úÖ"},
                    {"id": "4.1.6", "text": "Restricci√≥n por suscripci√≥n/niveles (funciones SQL implementadas)", "status": "‚úÖ"},
                    {"id": "4.1.7", "text": "Verificar que las restricciones funcionan correctamente en frontend", "status": "‚è≥"},
                    {"id": "4.1.8", "text": "Agregar checks visuales de restricci√≥n en m√≥dulos", "status": "‚è≥"}
                ]},
                {"id": "4.2", "title": "4.2 Configuraci√≥n", "items": [
                    {"id": "4.2.1", "text": "Configuraci√≥n por comunidad", "status": "‚úÖ"},
                    {"id": "4.2.2", "text": "Men√∫ secundario personalizable", "status": "‚úÖ"},
                    {"id": "4.2.3", "text": "Temas de color din√°micos", "status": "‚úÖ"},
                    {"id": "4.2.4", "text": "Upload de logos e im√°genes", "status": "‚úÖ"}
                ]}
            ]},
            { "id": "5", "title": "üí∞ 5. SISTEMA DE SUSCRIPCIONES", "tasks": [
                {"id": "5.1", "title": "5.1 Planes de Suscripci√≥n", "items": [
                    {"id": "5.1.1", "text": "Tabla `planes_suscripcion`", "status": "‚úÖ"},
                    {"id": "5.1.2", "text": "Caracter√≠sticas JSONB flexibles", "status": "‚úÖ"},
                    {"id": "5.1.3", "text": "Soporte multi-moneda (USD, EUR, MXN, COP)", "status": "‚úÖ"},
                    {"id": "5.1.4", "text": "Sistema de pruebas gratis configurable", "status": "‚úÖ"},
                    {"id": "5.1.5", "text": "Categorizaci√≥n (B√°sico, Premium, Enterprise)", "status": "‚úÖ"},
                    {"id": "5.1.6", "text": "Colores personalizados", "status": "‚úÖ"},
                    {"id": "5.1.7", "text": "Planes destacados", "status": "‚úÖ"},
                    {"id": "5.1.8", "text": "Agregar campo `stripe_price_id` a tabla (CR√çTICO)", "status": "‚è≥"},
                    {"id": "5.1.9", "text": "Crear producto en Stripe autom√°ticamente al guardar plan", "status": "‚è≥"}
                ]},
                {"id": "5.2", "title": "5.2 Gesti√≥n de Suscripciones", "items": [
                    {"id": "5.2.1", "text": "Portal de Suscripciones integrado", "status": "‚úÖ"},
                    {"id": "5.2.2", "text": "Conexi√≥n autom√°tica con cursos y servicios", "status": "‚úÖ"},
                    {"id": "5.2.3", "text": "Estad√≠sticas y m√©tricas", "status": "‚úÖ"},
                    {"id": "5.2.4", "text": "Tasa de conversi√≥n autom√°tica", "status": "‚úÖ"},
                    {"id": "5.2.5", "text": "Plan m√°s popular identificado", "status": "‚úÖ"},
                    {"id": "5.2.6", "text": "Verificar activaci√≥n autom√°tica desde webhook de Stripe", "status": "‚è≥"},
                    {"id": "5.2.7", "text": "Manejar cancelaciones y renovaciones", "status": "‚è≥"}
                ]},
                {"id": "5.3", "title": "5.3 Restricciones por Suscripci√≥n/Niveles", "items": [
                    {"id": "5.3.1", "text": "Funciones SQL para verificar acceso por suscripci√≥n", "status": "‚úÖ"},
                    {"id": "5.3.2", "text": "Verificaci√≥n de acceso en canales", "status": "‚úÖ"},
                    {"id": "5.3.3", "text": "Implementar checks de restricci√≥n en m√≥dulos de Classroom", "status": "‚è≥"},
                    {"id": "5.3.4", "text": "Implementar checks de restricci√≥n en herramientas (Alpha X100, Trading Lab, etc.)", "status": "‚è≥"},
                    {"id": "5.3.5", "text": "Agregar UI visual cuando el contenido est√° restringido", "status": "‚è≥"},
                    {"id": "5.3.6", "text": "Mensajes informativos sobre qu√© plan se necesita", "status": "‚è≥"}
                ]}
            ]},
            { "id": "6", "title": "ü§ù 6. SISTEMA DE AFILIADOS", "tasks": [
                {"id": "6.1", "title": "6.1 Estructura Base", "items": [
                    {"id": "6.1.1", "text": "Sistema de c√≥digos IB √∫nicos (IB001, IB002, etc.)", "status": "‚úÖ"},
                    {"id": "6.1.2", "text": "C√≥digos independientes por comunidad", "status": "‚úÖ"},
                    {"id": "6.1.3", "text": "C√≥digos Hospper con sufijo `H`", "status": "‚úÖ"},
                    {"id": "6.1.4", "text": "Dashboard completo para afiliados", "status": "‚úÖ"},
                    {"id": "6.1.5", "text": "Historial de transacciones", "status": "‚úÖ"},
                    {"id": "6.1.6", "text": "Ejecutar scripts SQL de correcci√≥n pendientes", "status": "‚è≥"},
                    {"id": "6.1.7", "text": "Verificar que el tracking funciona correctamente", "status": "‚è≥"}
                ]},
                {"id": "6.2", "title": "6.2 Tracking", "items": [
                    {"id": "6.2.1", "text": "Tabla `codigos_afiliado`", "status": "‚úÖ"},
                    {"id": "6.2.2", "text": "Tabla `clicks_afiliado`", "status": "‚úÖ"},
                    {"id": "6.2.3", "text": "Tabla `comisiones_afiliado`", "status": "‚úÖ"},
                    {"id": "6.2.4", "text": "Tabla `conversiones_afiliado`", "status": "‚úÖ"},
                    {"id": "6.2.5", "text": "Funciones RPC optimizadas", "status": "‚úÖ"},
                    {"id": "6.2.6", "text": "Verificar que se registran clicks correctamente", "status": "‚è≥"},
                    {"id": "6.2.7", "text": "Verificar que se registran leads al registrarse usuarios", "status": "‚è≥"},
                    {"id": "6.2.8", "text": "Eliminar creaci√≥n de ventas falsas autom√°ticas", "status": "‚è≥"}
                ]},
                {"id": "6.3", "title": "6.3 Funcionalidades", "items": [
                    {"id": "6.3.1", "text": "Generaci√≥n autom√°tica de c√≥digos", "status": "‚úÖ"},
                    {"id": "6.3.2", "text": "Links de afiliado personalizables", "status": "‚úÖ"},
                    {"id": "6.3.3", "text": "C√°lculo de saldo disponible", "status": "‚úÖ"},
                    {"id": "6.3.4", "text": "Sistema de retiros con validaciones", "status": "‚úÖ"},
                    {"id": "6.3.5", "text": "Transferencias entre c√≥digos IB", "status": "‚úÖ"},
                    {"id": "6.3.6", "text": "Comisiones multinivel (3 niveles) - estructura implementada", "status": "‚úÖ"},
                    {"id": "6.3.7", "text": "Verificar que las comisiones multinivel se calculan correctamente", "status": "‚è≥"},
                    {"id": "6.3.8", "text": "Verificar que las comisiones se asignan autom√°ticamente en ventas", "status": "‚è≥"}
                ]},
                {"id": "6.4", "title": "6.4 Panel de Afiliados", "items": [
                    {"id": "6.4.1", "text": "Dashboard con m√©tricas en tiempo real", "status": "‚úÖ"},
                    {"id": "6.4.2", "text": "P√°gina de enlaces de afiliado", "status": "‚úÖ"},
                    {"id": "6.4.3", "text": "P√°gina de retiros", "status": "‚úÖ"},
                    {"id": "6.4.4", "text": "P√°gina de transferencias", "status": "‚úÖ"},
                    {"id": "6.4.5", "text": "P√°gina de historial", "status": "‚úÖ"},
                    {"id": "6.4.6", "text": "P√°gina multinivel", "status": "‚úÖ"},
                    {"id": "6.4.7", "text": "Conectar historial a datos reales", "status": "‚è≥"},
                    {"id": "6.4.8", "text": "Verificar que todas las m√©tricas se muestran correctamente", "status": "‚è≥"}
                ]},
                {"id": "6.5", "title": "6.5 Sistema Multinivel Completo", "items": [
                    {"id": "6.5.1", "text": "Verificar que el sistema de 3 niveles funciona correctamente", "status": "‚è≥"},
                    {"id": "6.5.2", "text": "Verificar asignaci√≥n de `afiliado_referente` en todos los niveles", "status": "‚è≥"},
                    {"id": "6.5.3", "text": "Probar flujo completo: registro ‚Üí compra ‚Üí comisi√≥n multinivel", "status": "‚è≥"},
                    {"id": "6.5.4", "text": "Verificar notificaciones a todos los niveles", "status": "‚è≥"}
                ]}
            ]},
            { "id": "7", "title": "üí≥ 7. INTEGRACI√ìN DE PAGOS", "tasks": [
                {"id": "7.1", "title": "7.1 Stripe", "items": [
                    {"id": "7.1.1", "text": "Microservicio Stripe deployado", "status": "‚úÖ"},
                    {"id": "7.1.2", "text": "Endpoints API implementados", "status": "‚úÖ"},
                    {"id": "7.1.3", "text": "Servicio frontend `stripeService.ts`", "status": "‚úÖ"},
                    {"id": "7.1.4", "text": "Componente `StripePaymentButton`", "status": "‚úÖ"},
                    {"id": "7.1.5", "text": "Variables de entorno configuradas", "status": "‚úÖ"},
                    {"id": "7.1.6", "text": "Webhook configurado para eventos", "status": "‚úÖ"},
                    {"id": "7.1.7", "text": "Conectar botones de compra en marketplace", "status": "‚è≥"},
                    {"id": "7.1.8", "text": "Crear p√°ginas de √©xito/error despu√©s del pago (`/success`, `/cancel`)", "status": "‚è≥"},
                    {"id": "7.1.9", "text": "Verificar creaci√≥n de ventas en BD desde webhook", "status": "‚è≥"},
                    {"id": "7.1.10", "text": "Integrar comisiones autom√°ticas de afiliados en webhook", "status": "‚è≥"},
                    {"id": "7.1.11", "text": "Agregar campo `stripe_price_id` a todas las tablas de productos", "status": "‚è≥"},
                    {"id": "7.1.12", "text": "Crear productos en Stripe autom√°ticamente al guardar", "status": "‚è≥"},
                    {"id": "7.1.13", "text": "Probar flujo completo de pago (crear ‚Üí pagar ‚Üí activar)", "status": "‚è≥"}
                ]},
                {"id": "7.2", "title": "7.2 Pagos Crypto (NOWPayments/CoinGate)", "items": [
                    {"id": "7.2.1", "text": "Endpoints API para NOWPayments", "status": "‚úÖ"},
                    {"id": "7.2.2", "text": "Endpoints API para CoinGate", "status": "‚úÖ"},
                    {"id": "7.2.3", "text": "Webhooks implementados", "status": "‚úÖ"},
                    {"id": "7.2.4", "text": "Verificar que los webhooks funcionan correctamente", "status": "‚è≥"},
                    {"id": "7.2.5", "text": "Probar flujo completo de pago crypto", "status": "‚è≥"},
                    {"id": "7.2.6", "text": "Verificar creaci√≥n de ventas en BD", "status": "‚è≥"},
                    {"id": "7.2.7", "text": "Integrar comisiones autom√°ticas de afiliados", "status": "‚è≥"},
                    {"id": "7.2.8", "text": "Panel admin para gestionar pagos crypto", "status": "‚è≥"}
                ]},
                {"id": "7.3", "title": "7.3 Otros M√©todos de Pago", "items": [
                    {"id": "7.3.1", "text": "Integrar PayPal", "status": "‚ùå"},
                    {"id": "7.3.2", "text": "Integrar pagos locales (Yape, Plin, Nequi, etc.)", "status": "‚ùå"},
                    {"id": "7.3.3", "text": "Sistema de pagos contraentrega", "status": "‚ùå"},
                    {"id": "7.3.4", "text": "Panel admin para gestionar m√©todos de pago", "status": "‚ùå"}
                ]}
            ]},
            { "id": "8", "title": "üìö 8. SISTEMA CLASSROOM", "tasks": [
                {"id": "8.1", "title": "8.1 Funcionalidades Base", "items": [
                    {"id": "8.1.1", "text": "Gesti√≥n de cursos y m√≥dulos", "status": "‚úÖ"},
                    {"id": "8.1.2", "text": "Subida y visualizaci√≥n de videos", "status": "‚úÖ"},
                    {"id": "8.1.3", "text": "Sistema de progreso", "status": "‚úÖ"},
                    {"id": "8.1.4", "text": "Edici√≥n de contenido", "status": "‚úÖ"},
                    {"id": "8.1.5", "text": "Organizaci√≥n por m√≥dulos", "status": "‚úÖ"},
                    {"id": "8.1.6", "text": "Implementar restricciones por suscripci√≥n/niveles", "status": "‚è≥"},
                    {"id": "8.1.7", "text": "Agregar checks visuales de restricci√≥n", "status": "‚è≥"}
                ]},
                {"id": "8.2", "title": "8.2 Funcionalidades Avanzadas", "items": [
                    {"id": "8.2.1", "text": "Certificados de finalizaci√≥n autom√°ticos", "status": "‚ùå"},
                    {"id": "8.2.2", "text": "Sistema de calificaciones y ex√°menes", "status": "‚ùå"},
                    {"id": "8.2.3", "text": "Comentarios y preguntas en videos", "status": "‚ùå"},
                    {"id": "8.2.4", "text": "Estad√≠sticas de progreso detalladas", "status": "‚ùå"}
                ]}
            ]},
            { "id": "9", "title": "üöÄ 9. SISTEMA LAUNCHPAD", "tasks": [
                {"id": "9.1", "title": "9.1 Funcionalidades", "items": [
                    {"id": "9.1.1", "text": "Sistema de eventos y calendario", "status": "‚úÖ"},
                    {"id": "9.1.2", "text": "Video destacado con contador regresivo", "status": "‚úÖ"},
                    {"id": "9.1.3", "text": "Barra lateral desplegable con logo personalizable", "status": "‚úÖ"},
                    {"id": "9.1.4", "text": "Botones personalizables con redirecci√≥n", "status": "‚úÖ"},
                    {"id": "9.1.5", "text": "Sistema de calificaciones y comentarios", "status": "‚úÖ"},
                    {"id": "9.1.6", "text": "Integraci√≥n con sistema de referidos", "status": "‚úÖ"},
                    {"id": "9.1.7", "text": "Carga de im√°genes en bucket dedicado", "status": "‚úÖ"},
                    {"id": "9.1.8", "text": "Editor completo desde panel admin", "status": "‚úÖ"},
                    {"id": "9.1.9", "text": "Colores unificados (paleta dorada)", "status": "‚úÖ"},
                    {"id": "9.1.10", "text": "Responsive design", "status": "‚úÖ"}
                ]}
            ]},
            { "id": "10", "title": "‚öôÔ∏è 10. PANEL ADMINISTRATIVO", "tasks": [
                {"id": "10.1", "title": "10.1 Secciones Implementadas", "items": [
                    {"id": "10.1.1", "text": "Dashboard general", "status": "‚úÖ"},
                    {"id": "10.1.2", "text": "Configuraci√≥n de comunidad", "status": "‚úÖ"},
                    {"id": "10.1.3", "text": "Gesti√≥n de canales (con drag & drop)", "status": "‚úÖ"},
                    {"id": "10.1.4", "text": "Gesti√≥n de cursos marketplace", "status": "‚úÖ"},
                    {"id": "10.1.5", "text": "Gesti√≥n de servicios marketplace", "status": "‚úÖ"},
                    {"id": "10.1.6", "text": "Portal de Suscripciones", "status": "‚úÖ"},
                    {"id": "10.1.7", "text": "Panel de Finanzas (Suscripciones, Ventas, Transacciones)", "status": "‚úÖ"},
                    {"id": "10.1.8", "text": "Panel de Afiliados", "status": "‚úÖ"},
                    {"id": "10.1.9", "text": "Gesti√≥n de Launchpad", "status": "‚úÖ"},
                    {"id": "10.1.10", "text": "Configuraci√≥n general", "status": "‚úÖ"},
                    {"id": "10.1.11", "text": "Email Marketing Panel", "status": "‚úÖ"}
                ]},
                {"id": "10.2", "title": "10.2 Funcionalidades Admin", "items": [
                    {"id": "10.2.1", "text": "Crear, editar, eliminar productos", "status": "‚úÖ"},
                    {"id": "10.2.2", "text": "Activar/desactivar productos", "status": "‚úÖ"},
                    {"id": "10.2.3", "text": "Subir im√°genes", "status": "‚úÖ"},
                    {"id": "10.2.4", "text": "Configurar precios y caracter√≠sticas", "status": "‚úÖ"},
                    {"id": "10.2.5", "text": "Estad√≠sticas y m√©tricas", "status": "‚úÖ"},
                    {"id": "10.2.6", "text": "Reportes", "status": "‚úÖ"}
                ]}
            ]},
            { "id": "11", "title": "üìß 11. SISTEMA DE EMAIL MARKETING", "tasks": [
                {"id": "11.1", "title": "11.1 Infraestructura", "items": [
                    {"id": "11.1.1", "text": "Integraci√≥n con SendGrid", "status": "‚úÖ"},
                    {"id": "11.1.2", "text": "Integraci√≥n con Resend", "status": "‚úÖ"},
                    {"id": "11.1.3", "text": "Sistema de plantillas en Supabase Storage", "status": "‚úÖ"},
                    {"id": "11.1.4", "text": "Variables din√°micas con Handlebars", "status": "‚úÖ"},
                    {"id": "11.1.5", "text": "White-Label: colores y branding din√°micos", "status": "‚úÖ"},
                    {"id": "11.1.6", "text": "Verificar que todas las plantillas funcionan correctamente", "status": "‚è≥"},
                    {"id": "11.1.7", "text": "Verificar que los emails se env√≠an correctamente", "status": "‚è≥"}
                ]},
                {"id": "11.2", "title": "11.2 Funcionalidades", "items": [
                    {"id": "11.2.1", "text": "Email de bienvenida al registrarse", "status": "‚úÖ"},
                    {"id": "11.2.2", "text": "Email cuando se crea un curso", "status": "‚úÖ"},
                    {"id": "11.2.3", "text": "Email masivo cuando admin/moderador publica", "status": "‚úÖ"},
                    {"id": "11.2.4", "text": "Notificaciones in-app (campanita)", "status": "‚úÖ"},
                    {"id": "11.2.5", "text": "Email de confirmaci√≥n de pago exitoso", "status": "‚è≥"},
                    {"id": "11.2.6", "text": "Email de pago fallido", "status": "‚è≥"},
                    {"id": "11.2.7", "text": "Email de activaci√≥n de suscripci√≥n", "status": "‚è≥"},
                    {"id": "11.2.8", "text": "Email de cancelaci√≥n de suscripci√≥n", "status": "‚è≥"},
                    {"id": "11.2.9", "text": "Sequence de emails autom√°ticos", "status": "‚è≥"},
                    {"id": "11.2.10", "text": "Recordatorios de vencimiento", "status": "‚è≥"}
                ]},
                {"id": "11.3", "title": "11.3 Notificaciones Push", "items": [
                    {"id": "11.3.1", "text": "Componente `PushNotificationManager.tsx` (frontend)", "status": "‚úÖ"},
                    {"id": "11.3.2", "text": "Service Worker implementado", "status": "‚úÖ"},
                    {"id": "11.3.3", "text": "Endpoint para guardar suscripciones push en BD", "status": "‚è≥"},
                    {"id": "11.3.4", "text": "Endpoint para enviar push notifications desde servidor", "status": "‚è≥"},
                    {"id": "11.3.5", "text": "Tabla en Supabase para almacenar suscripciones push", "status": "‚è≥"},
                    {"id": "11.3.6", "text": "Integraci√≥n de push en webhooks de pago", "status": "‚è≥"},
                    {"id": "11.3.7", "text": "Configurar VAPID keys", "status": "‚è≥"}
                ]}
            ]},
            { "id": "12", "title": "üîî 12. SISTEMA DE NOTIFICACIONES", "tasks": [
                {"id": "12.1", "title": "12.1 Notificaciones In-App", "items": [
                    {"id": "12.1.1", "text": "Tabla `notificaciones`", "status": "‚úÖ"},
                    {"id": "12.1.2", "text": "Sistema de campanita en Topbar", "status": "‚úÖ"},
                    {"id": "12.1.3", "text": "Actualizaci√≥n autom√°tica cada 30 segundos", "status": "‚úÖ"},
                    {"id": "12.1.4", "text": "Notificaciones filtradas por comunidad", "status": "‚úÖ"},
                    {"id": "12.1.5", "text": "Marcar como le√≠das", "status": "‚úÖ"},
                    {"id": "12.1.6", "text": "Verificar que todas las notificaciones se crean correctamente", "status": "‚è≥"}
                ]},
                {"id": "12.2", "title": "12.2 Notificaciones de Afiliados", "items": [
                    {"id": "12.2.1", "text": "Notificaciones de registro", "status": "‚úÖ"},
                    {"id": "12.2.2", "text": "Notificaciones de ventas", "status": "‚úÖ"},
                    {"id": "12.2.3", "text": "Notificaciones de suscripciones", "status": "‚úÖ"},
                    {"id": "12.2.4", "text": "Sistema multinivel (notifica a todos los niveles)", "status": "‚úÖ"},
                    {"id": "12.2.5", "text": "Verificar que las notificaciones se env√≠an a todos los niveles", "status": "‚è≥"},
                    {"id": "12.2.6", "text": "Verificar que las notificaciones incluyen informaci√≥n correcta", "status": "‚è≥"}
                ]},
                {"id": "12.3", "title": "12.3 Notificaciones de Ventas, Leads y Registros", "items": [
                    {"id": "12.3.1", "text": "Notificaciones de nuevos registros (implementado)", "status": "‚úÖ"},
                    {"id": "12.3.2", "text": "Notificaciones de ventas (implementado en webhook)", "status": "‚úÖ"},
                    {"id": "12.3.3", "text": "Verificar que las notificaciones de ventas se env√≠an correctamente", "status": "‚è≥"},
                    {"id": "12.3.4", "text": "Verificar que las notificaciones de leads se env√≠an correctamente", "status": "‚è≥"},
                    {"id": "12.3.5", "text": "Notificaciones de nuevos leads (pendiente verificar)", "status": "‚è≥"},
                    {"id": "12.3.6", "text": "Dashboard de notificaciones para admin", "status": "‚è≥"}
                ]}
            ]},
            { "id": "13", "title": "üîí 13. SEGURIDAD Y PERMISOS", "tasks": [
                {"id": "13.1", "title": "13.1 Restricciones por Suscripci√≥n/Niveles", "items": [
                    {"id": "13.1.1", "text": "Funciones SQL para verificar acceso", "status": "‚úÖ"},
                    {"id": "13.1.2", "text": "Verificaci√≥n en canales", "status": "‚úÖ"},
                    {"id": "13.1.3", "text": "Verificaci√≥n en Alpha X100", "status": "‚úÖ"},
                    {"id": "13.1.4", "text": "Implementar en todos los m√≥dulos de Classroom", "status": "‚è≥"},
                    {"id": "13.1.5", "text": "Implementar en Trading Lab", "status": "‚è≥"},
                    {"id": "13.1.6", "text": "Implementar en Crypto Health Scanner", "status": "‚è≥"},
                    {"id": "13.1.7", "text": "Implementar en todas las herramientas premium", "status": "‚è≥"},
                    {"id": "13.1.8", "text": "Agregar UI visual de restricci√≥n", "status": "‚è≥"},
                    {"id": "13.1.9", "text": "Mensajes informativos sobre planes requeridos", "status": "‚è≥"}
                ]},
                {"id": "13.2", "title": "13.2 Autenticaci√≥n 2FA", "items": [
                    {"id": "13.2.1", "text": "Integrar autenticador Google (2FA)", "status": "‚ùå"},
                    {"id": "13.2.2", "text": "Requerir 2FA para retiros y transferencias", "status": "‚ùå"},
                    {"id": "13.2.3", "text": "Panel de configuraci√≥n de 2FA", "status": "‚ùå"}
                ]},
                {"id": "13.3", "title": "13.3 Auditor√≠a y Logs", "items": [
                    {"id": "13.3.1", "text": "Mejorar sistema de logs", "status": "‚è≥"},
                    {"id": "13.3.2", "text": "Implementar rate limiting", "status": "‚è≥"},
                    {"id": "13.3.3", "text": "Sistema de auditor√≠a de acciones cr√≠ticas", "status": "‚è≥"}
                ]}
            ]},
            { "id": "14", "title": "üí∞ 14. WALLET XCOIN", "tasks": [
                {"id": "14.1", "title": "14.1 Infraestructura Base", "items": [
                    {"id": "14.1.1", "text": "Tabla `wallet_xcoin` en base de datos", "status": "‚ùå"},
                    {"id": "14.1.2", "text": "Tabla `transacciones_xcoin` para historial", "status": "‚ùå"},
                    {"id": "14.1.3", "text": "Sistema de balance y saldos", "status": "‚ùå"},
                    {"id": "14.1.4", "text": "Integraci√≥n con sistema de afiliados (comisiones en XCOIN)", "status": "‚ùå"},
                    {"id": "14.1.5", "text": "Integraci√≥n con sistema de pagos (dep√≥sitos)", "status": "‚ùå"}
                ]},
                {"id": "14.2", "title": "14.2 Frontend - Ver Saldos", "items": [
                    {"id": "14.2.1", "text": "P√°gina/componente de Wallet XCOIN", "status": "‚ùå"},
                    {"id": "14.2.2", "text": "Visualizaci√≥n de saldo actual", "status": "‚ùå"},
                    {"id": "14.2.3", "text": "Historial de transacciones", "status": "‚ùå"},
                    {"id": "14.2.4", "text": "Filtros por tipo de transacci√≥n (dep√≥sito, retiro, comisi√≥n, intercambio)", "status": "‚ùå"},
                    {"id": "14.2.5", "text": "Gr√°ficos de movimientos", "status": "‚ùå"},
                    {"id": "14.2.6", "text": "Dise√±o responsive y moderno", "status": "‚ùå"}
                ]},
                {"id": "14.3", "title": "14.3 Frontend - Enviar XCOIN", "items": [
                    {"id": "14.3.1", "text": "Formulario de env√≠o", "status": "‚ùå"},
                    {"id": "14.3.2", "text": "Validaci√≥n de destinatario (email o c√≥digo IB)", "status": "‚ùå"},
                    {"id": "14.3.3", "text": "Validaci√≥n de saldo suficiente", "status": "‚ùå"},
                    {"id": "14.3.4", "text": "Confirmaci√≥n de transacci√≥n", "status": "‚ùå"},
                    {"id": "14.3.5", "text": "Notificaci√≥n al destinatario", "status": "‚ùå"},
                    {"id": "14.3.6", "text": "Registro en historial", "status": "‚ùå"}
                ]},
                {"id": "14.4", "title": "14.4 Frontend - Intercambiar XCOIN", "items": [
                    {"id": "14.4.1", "text": "Interfaz de intercambio", "status": "‚ùå"},
                    {"id": "14.4.2", "text": "Conversi√≥n XCOIN a USD/EUR/etc.", "status": "‚ùå"},
                    {"id": "14.4.3", "text": "Conversi√≥n de otras monedas a XCOIN", "status": "‚ùå"},
                    {"id": "14.4.4", "text": "Tasas de cambio en tiempo real", "status": "‚ùå"},
                    {"id": "14.4.5", "text": "Confirmaci√≥n de intercambio", "status": "‚ùå"},
                    {"id": "14.4.6", "text": "Registro en historial", "status": "‚ùå"}
                ]},
                {"id": "14.5", "title": "14.5 Frontend - Retirar XCOIN", "items": [
                    {"id": "14.5.1", "text": "Formulario de retiro", "status": "‚ùå"},
                    {"id": "14.5.2", "text": "Validaci√≥n de monto m√≠nimo", "status": "‚ùå"},
                    {"id": "14.5.3", "text": "Selecci√≥n de m√©todo de retiro (crypto, transferencia bancaria, etc.)", "status": "‚ùå"},
                    {"id": "14.5.4", "text": "Validaci√≥n de datos de retiro", "status": "‚ùå"},
                    {"id": "14.5.5", "text": "Confirmaci√≥n de solicitud", "status": "‚ùå"},
                    {"id": "14.5.6", "text": "Estado de solicitud (pendiente, procesado, rechazado)", "status": "‚ùå"},
                    {"id": "14.5.7", "text": "Notificaci√≥n al admin para procesar retiro", "status": "‚ùå"}
                ]},
                {"id": "14.6", "title": "14.6 Backend - APIs", "items": [
                    {"id": "14.6.1", "text": "Endpoint para obtener saldo de usuario", "status": "‚ùå"},
                    {"id": "14.6.2", "text": "Endpoint para enviar XCOIN", "status": "‚ùå"},
                    {"id": "14.6.3", "text": "Endpoint para intercambiar XCOIN", "status": "‚ùå"},
                    {"id": "14.6.4", "text": "Endpoint para solicitar retiro", "status": "‚ùå"},
                    {"id": "14.6.5", "text": "Endpoint para historial de transacciones", "status": "‚ùå"},
                    {"id": "14.6.6", "text": "Endpoint admin para procesar retiros", "status": "‚ùå"},
                    {"id": "14.6.7", "text": "Validaciones de seguridad y permisos", "status": "‚ùå"}
                ]},
                {"id": "14.7", "title": "14.7 Integraci√≥n con Sistema de Afiliados", "items": [
                    {"id": "14.7.1", "text": "Asignar comisiones CPA en XCOIN autom√°ticamente", "status": "‚ùå"},
                    {"id": "14.7.2", "text": "Notificar afiliado cuando recibe comisi√≥n en XCOIN", "status": "‚ùå"},
                    {"id": "14.7.3", "text": "Dashboard de afiliados muestra saldo XCOIN", "status": "‚ùå"},
                    {"id": "14.7.4", "text": "Opci√≥n de retirar comisiones en XCOIN", "status": "‚ùå"}
                ]},
                {"id": "14.8", "title": "14.8 Integraci√≥n con Pagos", "items": [
                    {"id": "14.8.1", "text": "Dep√≥sitos desde Stripe se convierten a XCOIN (opcional)", "status": "‚ùå"},
                    {"id": "14.8.2", "text": "Dep√≥sitos desde NOWPayments se convierten a XCOIN (opcional)", "status": "‚ùå"},
                    {"id": "14.8.3", "text": "Configuraci√≥n de tasa de conversi√≥n", "status": "‚ùå"},
                    {"id": "14.8.4", "text": "Historial de dep√≥sitos", "status": "‚ùå"}
                ]},
                {"id": "14.9", "title": "14.9 Panel Admin - Gesti√≥n de Retiros", "items": [
                    {"id": "14.9.1", "text": "Lista de solicitudes de retiro pendientes", "status": "‚ùå"},
                    {"id": "14.9.2", "text": "Detalles de cada solicitud", "status": "‚ùå"},
                    {"id": "14.9.3", "text": "Procesar retiro (aprobar/rechazar)", "status": "‚ùå"},
                    {"id": "14.9.4", "text": "Enviar email de confirmaci√≥n al usuario", "status": "‚ùå"},
                    {"id": "14.9.5", "text": "Actualizar estado de retiro", "status": "‚ùå"},
                    {"id": "14.9.6", "text": "Historial completo de retiros procesados", "status": "‚ùå"}
                ]}
            ]},
            { "id": "15", "title": "üß™ 15. PRUEBAS Y VERIFICACIONES", "tasks": [
                {"id": "15.1", "title": "15.1 Pruebas de Suscripciones", "items": [
                    {"id": "15.1.1", "text": "Probar creaci√≥n de suscripci√≥n", "status": "‚è≥"},
                    {"id": "15.1.2", "text": "Probar activaci√≥n autom√°tica desde webhook", "status": "‚è≥"},
                    {"id": "15.1.3", "text": "Probar cancelaci√≥n", "status": "‚è≥"},
                    {"id": "15.1.4", "text": "Probar renovaci√≥n", "status": "‚è≥"},
                    {"id": "15.1.5", "text": "Probar restricciones de acceso", "status": "‚è≥"}
                ]},
                {"id": "15.2", "title": "15.2 Pruebas de Pagos Stripe", "items": [
                    {"id": "15.2.1", "text": "Probar pago √∫nico", "status": "‚è≥"},
                    {"id": "15.2.2", "text": "Probar suscripci√≥n recurrente", "status": "‚è≥"},
                    {"id": "15.2.3", "text": "Probar webhook de eventos", "status": "‚è≥"},
                    {"id": "15.2.4", "text": "Probar creaci√≥n de ventas en BD", "status": "‚è≥"},
                    {"id": "15.2.5", "text": "Probar asignaci√≥n de comisiones de afiliados", "status": "‚è≥"},
                    {"id": "15.2.6", "text": "Probar p√°ginas de √©xito/error", "status": "‚è≥"}
                ]},
                {"id": "15.3", "title": "15.3 Pruebas de Pagos Crypto", "items": [
                    {"id": "15.3.1", "text": "Probar pago con NOWPayments", "status": "‚è≥"},
                    {"id": "15.3.2", "text": "Probar pago con CoinGate", "status": "‚è≥"},
                    {"id": "15.3.3", "text": "Probar webhooks", "status": "‚è≥"},
                    {"id": "15.3.4", "text": "Probar creaci√≥n de ventas en BD", "status": "‚è≥"},
                    {"id": "15.3.5", "text": "Probar asignaci√≥n de comisiones", "status": "‚è≥"}
                ]},
                {"id": "15.4", "title": "15.4 Pruebas de Sistema de Afiliados", "items": [
                    {"id": "15.4.1", "text": "Probar registro con tracking", "status": "‚è≥"},
                    {"id": "15.4.2", "text": "Probar clicks en links de afiliado", "status": "‚è≥"},
                    {"id": "15.4.3", "text": "Probar creaci√≥n de leads", "status": "‚è≥"},
                    {"id": "15.4.4", "text": "Probar asignaci√≥n de comisiones multinivel", "status": "‚è≥"},
                    {"id": "15.4.5", "text": "Probar notificaciones a afiliados", "status": "‚è≥"},
                    {"id": "15.4.6", "text": "Probar retiros", "status": "‚è≥"},
                    {"id": "15.4.7", "text": "Probar transferencias", "status": "‚è≥"}
                ]},
                {"id": "15.5", "title": "15.5 Pruebas Generales", "items": [
                    {"id": "15.5.1", "text": "Probar flujo completo de registro ‚Üí compra ‚Üí comisi√≥n", "status": "‚è≥"},
                    {"id": "15.5.2", "text": "Probar restricciones por suscripci√≥n en todos los m√≥dulos", "status": "‚è≥"},
                    {"id": "15.5.3", "text": "Probar sistema de notificaciones completo", "status": "‚è≥"},
                    {"id": "15.5.4", "text": "Probar sistema de emails completo", "status": "‚è≥"},
                    {"id": "15.5.5", "text": "Probar multi-tenant (m√∫ltiples comunidades)", "status": "‚è≥"}
                ]},
                {"id": "15.6", "title": "15.6 Pruebas E2E (End-to-End) - Flujo Completo", "items": [
                    {"id": "15.6.1", "text": "E2E-1: Registro con link de afiliado", "status": "‚ùå"},
                    {"id": "15.6.2", "text": "E2E-2: Aprobaci√≥n FTD (First Time Deposit)", "status": "‚ùå"},
                    {"id": "15.6.3", "text": "E2E-3: Comisi√≥n CPA en XCOIN", "status": "‚ùå"},
                    {"id": "15.6.4", "text": "E2E-4: Formulario MT4/MT5", "status": "‚ùå"},
                    {"id": "15.6.5", "text": "E2E-5: Conexi√≥n Manual y Activaci√≥n", "status": "‚ùå"},
                    {"id": "15.6.6", "text": "E2E-6: Solicitud de Retiro de XCOIN", "status": "‚ùå"},
                    {"id": "15.6.7", "text": "E2E-7: Procesamiento de Retiro por Admin", "status": "‚ùå"}
                ]},
                {"id": "15.7", "title": "15.7 Pruebas E2E - Conectar Formularios y Botones", "items": [
                    {"id": "15.7.1", "text": "Full-Stack: Conectar formularios de compra", "status": "‚ùå"},
                    {"id": "15.7.2", "text": "Full-Stack: Probar flujo de compra (Stripe)", "status": "‚ùå"},
                    {"id": "15.7.3", "text": "Full-Stack: Probar flujo de dep√≥sito (NOWPayments)", "status": "‚ùå"}
                ]}
            ]},
            { "id": "16", "title": "üì± 16. DESARROLLO DE APPS M√ìVILES", "tasks": [
                {"id": "16.1", "title": "16.1 Infraestructura Base", "items": [
                    {"id": "16.1.1", "text": "Configurar proyecto React Native o Flutter", "status": "‚ùå"},
                    {"id": "16.1.2", "text": "Configurar entorno de desarrollo (Android Studio, Xcode)", "status": "‚ùå"},
                    {"id": "16.1.3", "text": "Configurar autenticaci√≥n m√≥vil (Supabase Auth)", "status": "‚ùå"},
                    {"id": "16.1.4", "text": "Configurar API endpoints para m√≥vil", "status": "‚ùå"},
                    {"id": "16.1.5", "text": "Configurar push notifications m√≥viles", "status": "‚ùå"},
                    {"id": "16.1.6", "text": "Configurar deep linking", "status": "‚ùå"}
                ]},
                {"id": "16.2", "title": "16.2 App Android", "items": [
                    {"id": "16.2.1", "text": "Estructura Base", "status": "‚ùå"},
                    {"id": "16.2.2", "text": "Autenticaci√≥n", "status": "‚ùå"},
                    {"id": "16.2.3", "text": "Navegaci√≥n Principal", "status": "‚ùå"},
                    {"id": "16.2.4", "text": "Funcionalidades Core", "status": "‚ùå"},
                    {"id": "16.2.5", "text": "Wallet XCOIN M√≥vil", "status": "‚ùå"},
                    {"id": "16.2.6", "text": "Sistema de Afiliados M√≥vil", "status": "‚ùå"},
                    {"id": "16.2.7", "text": "Pagos M√≥vil", "status": "‚ùå"},
                    {"id": "16.2.8", "text": "Optimizaciones Android", "status": "‚ùå"}
                ]},
                {"id": "16.3", "title": "16.3 App iOS (Apple)", "items": [
                    {"id": "16.3.1", "text": "Estructura Base", "status": "‚ùå"},
                    {"id": "16.3.2", "text": "Autenticaci√≥n", "status": "‚ùå"},
                    {"id": "16.3.3", "text": "Navegaci√≥n Principal", "status": "‚ùå"},
                    {"id": "16.3.4", "text": "Funcionalidades Core", "status": "‚ùå"},
                    {"id": "16.3.5", "text": "Wallet XCOIN M√≥vil", "status": "‚ùå"},
                    {"id": "16.3.6", "text": "Sistema de Afiliados M√≥vil", "status": "‚ùå"},
                    {"id": "16.3.7", "text": "Pagos M√≥vil", "status": "‚ùå"},
                    {"id": "16.3.8", "text": "Optimizaciones iOS", "status": "‚ùå"}
                ]},
                {"id": "16.4", "title": "16.4 Funcionalidades Compartidas (Android + iOS)", "items": [
                    {"id": "16.4.1", "text": "Offline Mode", "status": "‚ùå"},
                    {"id": "16.4.2", "text": "Push Notifications", "status": "‚ùå"},
                    {"id": "16.4.3", "text": "Biometr√≠a", "status": "‚ùå"},
                    {"id": "16.4.4", "text": "Compartir Contenido", "status": "‚ùå"},
                    {"id": "16.4.5", "text": "B√∫squeda", "status": "‚ùå"}
                ]},
                {"id": "16.5", "title": "16.5 Testing y QA", "items": [
                    {"id": "16.5.1", "text": "Tests unitarios", "status": "‚ùå"},
                    {"id": "16.5.2", "text": "Tests de integraci√≥n", "status": "‚ùå"},
                    {"id": "16.5.3", "text": "Tests E2E en dispositivos reales", "status": "‚ùå"},
                    {"id": "16.5.4", "text": "Testing en diferentes versiones de Android/iOS", "status": "‚ùå"},
                    {"id": "16.5.5", "text": "Testing en diferentes tama√±os de pantalla", "status": "‚ùå"},
                    {"id": "16.5.6", "text": "Testing de rendimiento", "status": "‚ùå"},
                    {"id": "16.5.7", "text": "Testing de seguridad", "status": "‚ùå"}
                ]},
                {"id": "16.6", "title": "16.6 Deployment", "items": [
                    {"id": "16.6.1", "text": "Android", "status": "‚ùå"},
                    {"id": "16.6.2", "text": "iOS", "status": "‚ùå"}
                ]},
                {"id": "16.7", "title": "16.7 Monitoreo y Analytics", "items": [
                    {"id": "16.7.1", "text": "Integrar Firebase Analytics", "status": "‚ùå"},
                    {"id": "16.7.2", "text": "Integrar Crashlytics", "status": "‚ùå"},
                    {"id": "16.7.3", "text": "Monitoreo de rendimiento", "status": "‚ùå"},
                    {"id": "16.7.4", "text": "Tracking de eventos de usuario", "status": "‚ùå"},
                    {"id": "16.7.5", "text": "Reportes de errores", "status": "‚ùå"}
                ]}
            ]},
            { "id": "17", "title": "üõ†Ô∏è 17. HERRAMIENTAS Y FUNCIONALIDADES ESPECIALES", "tasks": [
                {"id": "17.1", "title": "17.1 Alpha X100", "items": [
                    {"id": "17.1.1", "text": "Panel de administraci√≥n", "status": "‚úÖ"},
                    {"id": "17.1.2", "text": "Sistema de tokens", "status": "‚úÖ"},
                    {"id": "17.1.3", "text": "Restricciones por suscripci√≥n implementadas", "status": "‚úÖ"},
                    {"id": "17.1.4", "text": "Verificar que las restricciones funcionan correctamente", "status": "‚è≥"}
                ]},
                {"id": "17.2", "title": "17.2 Trading Lab", "items": [
                    {"id": "17.2.1", "text": "Implementado", "status": "‚úÖ"},
                    {"id": "17.2.2", "text": "Agregar restricciones por suscripci√≥n/niveles", "status": "‚è≥"},
                    {"id": "17.2.3", "text": "Verificar funcionamiento", "status": "‚è≥"}
                ]},
                {"id": "17.3", "title": "17.3 Crypto Health Scanner", "items": [
                    {"id": "17.3.1", "text": "Implementado", "status": "‚úÖ"},
                    {"id": "17.3.2", "text": "Agregar restricciones por suscripci√≥n/niveles", "status": "‚è≥"},
                    {"id": "17.3.3", "text": "Verificar funcionamiento", "status": "‚è≥"}
                ]},
                {"id": "17.4", "title": "17.4 Otras Herramientas", "items": [
                    {"id": "17.4.1", "text": "Verificar que todas las herramientas funcionan correctamente", "status": "‚è≥"},
                    {"id": "17.4.2", "text": "Agregar restricciones donde sea necesario", "status": "‚è≥"},
                    {"id": "17.4.3", "text": "Optimizar rendimiento", "status": "‚è≥"}
                ]}
            ]},
            { "id": "18", "title": "üåê 18. SISTEMA WHITE-LABEL", "tasks": [
                {"id": "18.1", "title": "18.1 Dominios Personalizados", "items": [
                    {"id": "18.1.1", "text": "Tabla `dominios_white_label`", "status": "‚úÖ"},
                    {"id": "18.1.2", "text": "API de verificaci√≥n de nameservers", "status": "‚úÖ"},
                    {"id": "18.1.3", "text": "Panel admin para gesti√≥n de dominios", "status": "‚úÖ"},
                    {"id": "18.1.4", "text": "Sistema de detecci√≥n autom√°tica de comunidad por dominio", "status": "‚úÖ"},
                    {"id": "18.1.5", "text": "Mantener dominio en navegaci√≥n despu√©s de detectarlo", "status": "‚è≥"},
                    {"id": "18.1.6", "text": "Configurar SSL autom√°tico", "status": "‚è≥"},
                    {"id": "18.1.7", "text": "Verificar que el sistema funciona correctamente", "status": "‚è≥"}
                ]},
                {"id": "18.2", "title": "18.2 Configuraci√≥n Multi-Tenant", "items": [
                    {"id": "18.2.1", "text": "Sistema de comunidades independientes", "status": "‚úÖ"},
                    {"id": "18.2.2", "text": "Configuraci√≥n por comunidad", "status": "‚úÖ"},
                    {"id": "18.2.3", "text": "Completar migraci√≥n de `community_id` en todas las tablas", "status": "‚è≥"},
                    {"id": "18.2.4", "text": "Verificar aislamiento de datos entre comunidades", "status": "‚è≥"}
                ]}
            ]},
            { "id": "19", "title": "üìä 19. ANALYTICS Y REPORTES", "tasks": [
                {"id": "19.1", "title": "19.1 Dashboard de M√©tricas", "items": [
                    {"id": "19.1.1", "text": "Estad√≠sticas b√°sicas en paneles admin", "status": "‚úÖ"},
                    {"id": "19.1.2", "text": "Dashboard con gr√°ficos interactivos", "status": "‚è≥"},
                    {"id": "19.1.3", "text": "Reportes personalizables", "status": "‚è≥"},
                    {"id": "19.1.4", "text": "Exportar datos (CSV, PDF)", "status": "‚è≥"},
                    {"id": "19.1.5", "text": "An√°lisis de cohortes", "status": "‚è≥"}
                ]},
                {"id": "19.2", "title": "19.2 M√©tricas de Afiliados", "items": [
                    {"id": "19.2.1", "text": "Dashboard de afiliados con m√©tricas b√°sicas", "status": "‚úÖ"},
                    {"id": "19.2.2", "text": "Gr√°ficos avanzados", "status": "‚è≥"},
                    {"id": "19.2.3", "text": "Reportes detallados", "status": "‚è≥"},
                    {"id": "19.2.4", "text": "Exportar reportes", "status": "‚è≥"}
                ]}
            ]},
            { "id": "20", "title": "üêõ 20. ERRORES CONOCIDOS Y CORRECCIONES PENDIENTES", "tasks": [
                {"id": "20.1", "title": "20.1 Errores Cr√≠ticos", "items": [
                    {"id": "20.1.1", "text": "Registro no crea usuario en tabla usuarios", "status": "‚è≥"},
                    {"id": "20.1.2", "text": "Sistema de afiliados no registra clicks ni leads", "status": "‚è≥"},
                    {"id": "20.1.3", "text": "Ventas falsas autom√°ticas", "status": "‚è≥"},
                    {"id": "20.1.4", "text": "Tracking incompleto", "status": "‚è≥"},
                    {"id": "20.1.5", "text": "Botones de pago no funcionan", "status": "‚è≥"}
                ]},
                {"id": "20.2", "title": "20.2 Errores de Integraci√≥n", "items": [
                    {"id": "20.2.1", "text": "Webhooks no crean ventas correctamente", "status": "‚è≥"},
                    {"id": "20.2.2", "text": "Comisiones no se asignan autom√°ticamente", "status": "‚è≥"},
                    {"id": "20.2.3", "text": "Notificaciones no se env√≠an", "status": "‚è≥"},
                    {"id": "20.2.4", "text": "Emails no se env√≠an", "status": "‚è≥"}
                ]},
                {"id": "20.3", "title": "20.3 Errores de UI/UX", "items": [
                    {"id": "20.3.1", "text": "Dominios white-label no se mantienen despu√©s de login", "status": "‚è≥"},
                    {"id": "20.3.2", "text": "Restricciones no se muestran visualmente", "status": "‚è≥"},
                    {"id": "20.3.3", "text": "Mensajes de error poco claros", "status": "‚è≥"}
                ]}
            ]},
            { "id": "21", "title": "üöÄ 21. OPTIMIZACIONES Y MEJORAS", "tasks": [
                {"id": "21.1", "title": "21.1 Performance", "items": [
                    {"id": "21.1.1", "text": "Optimizar consultas SQL", "status": "‚è≥"},
                    {"id": "21.1.2", "text": "Implementar caching", "status": "‚è≥"},
                    {"id": "21.1.3", "text": "Optimizar carga de im√°genes", "status": "‚è≥"},
                    {"id": "21.1.4", "text": "Optimizar carga de componentes", "status": "‚è≥"}
                ]},
                {"id": "21.2", "title": "21.2 C√≥digo", "items": [
                    {"id": "21.2.1", "text": "Eliminar c√≥digo duplicado", "status": "‚è≥"},
                    {"id": "21.2.2", "text": "Mejorar manejo de errores", "status": "‚è≥"},
                    {"id": "21.2.3", "text": "Agregar tests automatizados", "status": "‚è≥"},
                    {"id": "21.2.4", "text": "Mejorar documentaci√≥n del c√≥digo", "status": "‚è≥"}
                ]},
                {"id": "21.3", "title": "21.3 UX/UI", "items": [
                    {"id": "21.3.1", "text": "Mejorar mensajes de error", "status": "‚è≥"},
                    {"id": "21.3.2", "text": "Agregar loading states", "status": "‚è≥"},
                    {"id": "21.3.3", "text": "Mejorar feedback visual", "status": "‚è≥"},
                    {"id": "21.3.4", "text": "Optimizar responsive design", "status": "‚è≥"}
                ]}
            ]},
            { "id": "22", "title": "üìù 22. DOCUMENTACI√ìN", "tasks": [
                {"id": "22.1", "title": "22.1 Documentaci√≥n T√©cnica", "items": [
                    {"id": "22.1.1", "text": "Gu√≠a de onboarding para desarrolladores", "status": "‚úÖ"},
                    {"id": "22.1.2", "text": "An√°lisis completo del proyecto", "status": "‚úÖ"},
                    {"id": "22.1.3", "text": "Documentaci√≥n de arquitectura", "status": "‚úÖ"},
                    {"id": "22.1.4", "text": "Documentaci√≥n de APIs", "status": "‚è≥"},
                    {"id": "22.1.5", "text": "Documentaci√≥n de base de datos", "status": "‚è≥"},
                    {"id": "22.1.6", "text": "Diagramas de flujo", "status": "‚è≥"}
                ]},
                {"id": "22.2", "title": "22.2 Documentaci√≥n de Usuario", "items": [
                    {"id": "22.2.1", "text": "Gu√≠as de usuario", "status": "‚ùå"},
                    {"id": "22.2.2", "text": "Tutoriales en video", "status": "‚ùå"},
                    {"id": "22.2.3", "text": "FAQ interactivo", "status": "‚ùå"},
                    {"id": "22.2.4", "text": "Documentaci√≥n de funcionalidades", "status": "‚ùå"}
                ]}
            ]}
        ];

        // --- Funciones de Inicializaci√≥n ---

        async function startApp() {
            try {
                // 1. Inicializar Firebase
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    showMessage("Error: Configuraci√≥n de Firebase incompleta.");
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                // --- L√ìGICA DE LOGIN CON GOOGLE ---
                loadingText.textContent = "Verificando autenticaci√≥n...";
                // Mostrar spinner y ocultar todo
                loadingSpinner.classList.remove('hidden');
                loginContainer.classList.add('hidden');
                mainAppContainer.classList.add('hidden');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Usuario est√° logueado
                        userId = user.uid;
                        console.log("Usuario conectado:", user.displayName, userId);
                        
                        // Mostrar estado en la app principal
                        authStatusMain.textContent = `Conectado: ${user.displayName}`;
                        authStatusMain.classList.remove('text-yellow-400');
                        authStatusMain.classList.add('text-green-400');
                        
                        // Ocultar login, mostrar app y spinner (mientras cargan datos)
                        loginContainer.classList.add('hidden');
                        mainAppContainer.classList.remove('hidden');
                        loadingSpinner.classList.remove('hidden'); // Spinner para datos
                        loadingText.textContent = "Cargando proyecto...";
                        
                        // 3. Una vez autenticado, configurar la referencia y escuchar cambios
                        setupFirestoreListener();
                    } else {
                        // Usuario no est√° logueado
                        console.log("Usuario no conectado.");
                        // Mostrar pantalla de login, ocultar app y spinner
                        loginContainer.classList.remove('hidden');
                        mainAppContainer.classList.add('hidden');
                        loadingSpinner.classList.add('hidden');
                        authStatusLogin.textContent = "Desconectado";
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showMessage(`Error al inicializar: ${error.message}`);
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- NUEVA: Funci√≥n de Login con Google ---
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                loadingSpinner.classList.remove('hidden');
                loadingText.textContent = "Abriendo ventana de Google...";
                await signInWithPopup(auth, provider);
                // onAuthStateChanged se encargar√° del resto
            } catch (error) {
                console.error("Error al iniciar sesi√≥n con Google:", error);
                // Si el error es por dominio no autorizado, da un mensaje claro
                if (error.code === 'auth/unauthorized-domain') {
                    showMessage("Error: Este dominio no est√° autorizado para iniciar sesi√≥n. Debes a√±adirlo a la lista de 'Dominios autorizados' en tu consola de Firebase (Authentication -> Sign-in method).");
                } else {
                    showMessage(`Error al iniciar sesi√≥n: ${error.message}`);
                }
                loadingSpinner.classList.add('hidden');
            }
        }


        // --- Cargar lista de proyectos ---
        async function loadProjectsList() {
            try {
                const projectsPath = `artifacts/${appId}/public/data/projects`;
                projectsListRef = collection(db, projectsPath);
                
                const querySnapshot = await getDocs(projectsListRef);
                const projects = [];
                
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    projects.push({
                        id: docSnap.id,
                        name: data.projectName || docSnap.id,
                        description: data.description || ''
                    });
                });
                
                // Ordenar por nombre
                projects.sort((a, b) => a.name.localeCompare(b.name));
                
                // Actualizar selector
                projectSelector.innerHTML = '';
                if (projects.length === 0) {
                    projectSelector.innerHTML = '<option value="">No hay proyectos</option>';
                    // Si no hay proyectos, crear uno por defecto
                    await createDefaultProject();
                    return;
                }
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    projectSelector.appendChild(option);
                });
                
                // Si hay un proyecto guardado en localStorage, seleccionarlo
                const savedProjectId = localStorage.getItem('lastSelectedProject');
                if (savedProjectId && projects.find(p => p.id === savedProjectId)) {
                    projectSelector.value = savedProjectId;
                    loadProject(savedProjectId);
                } else if (projects.length > 0) {
                    // Seleccionar el primer proyecto
                    projectSelector.value = projects[0].id;
                    loadProject(projects[0].id);
                }
                
            } catch (error) {
                console.error("Error al cargar lista de proyectos:", error);
                showMessage(`Error al cargar proyectos: ${error.message}`);
            }
        }

        // --- Crear proyecto por defecto (migraci√≥n) ---
        async function createDefaultProject() {
            try {
                const defaultProjectId = 'scalexone';
                const docPath = `artifacts/${appId}/public/data/projects/${defaultProjectId}`;
                const defaultDocRef = doc(db, docPath);
                
                const docSnap = await getDoc(defaultDocRef);
                if (!docSnap.exists()) {
                    await setDoc(defaultDocRef, {
                        projectName: "SCALEXONE",
                        description: "Proyecto principal de SCALEXONE",
                        content: JSON.stringify(initialProjectData),
                        priorities: JSON.stringify([]),
                        createdAt: new Date().toISOString()
                    });
                    console.log("Proyecto por defecto creado");
                }
                
                // Recargar lista
                await loadProjectsList();
            } catch (error) {
                console.error("Error al crear proyecto por defecto:", error);
            }
        }

        // --- Cargar un proyecto espec√≠fico ---
        function loadProject(projectId) {
            if (!projectId) return;
            
            currentProjectId = projectId;
            localStorage.setItem('lastSelectedProject', projectId);
            
            // Mostrar bot√≥n de eliminar
            deleteProjectBtn.classList.remove('hidden');
            
            try {
                const docPath = `artifacts/${appId}/public/data/projects/${projectId}`;
                projectDocRef = doc(db, docPath);

                // Escuchar cambios en tiempo real para ESE proyecto
                onSnapshot(projectDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        projectData = JSON.parse(data.content || "[]");
                        priorityTasks = JSON.parse(data.priorities || "[]");
                        
                        // Actualizar t√≠tulo del proyecto en el selector si existe
                        const option = projectSelector.querySelector(`option[value="${projectId}"]`);
                        if (option && data.projectName) {
                            option.textContent = data.projectName;
                        }
                        
                        console.log(`Datos cargados desde Firestore para el proyecto: ${projectId}`);
                    } else {
                        // El documento no existe, crear con datos iniciales
                        console.log("El documento del proyecto no existe, creando uno nuevo...");
                        projectData = [];
                        priorityTasks = [];
                        saveInitialData();
                    }
                    // Renderizar la UI con los datos
                    renderProject();
                    renderPriorityTasks();
                    loadingSpinner.classList.add('hidden');
                }, (error) => {
                    console.error("Error en onSnapshot (proyecto):", error);
                    showMessage(`Error al sincronizar datos: ${error.message}`);
                    loadingSpinner.classList.add('hidden');
                });
                
            } catch (error) {
                console.error("Error al cargar proyecto:", error);
                showMessage(`Error de configuraci√≥n: ${error.message}`);
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- Crear nuevo proyecto ---
        async function createNewProject() {
            const name = newProjectNameInput.value.trim();
            if (!name) {
                showMessage("Por favor, ingresa un nombre para el proyecto");
                return;
            }
            
            // Generar ID √∫nico (slug del nombre)
            const projectId = name.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            
            if (!projectId) {
                showMessage("El nombre del proyecto debe contener al menos una letra o n√∫mero");
                return;
            }
            
            try {
                loadingSpinner.classList.remove('hidden');
                loadingText.textContent = "Creando proyecto...";
                
                const docPath = `artifacts/${appId}/public/data/projects/${projectId}`;
                const newProjectRef = doc(db, docPath);
                
                // Verificar si ya existe
                const existingDoc = await getDoc(newProjectRef);
                if (existingDoc.exists()) {
                    showMessage("Ya existe un proyecto con ese nombre. Por favor, elige otro nombre.");
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                
                // Crear proyecto
                await setDoc(newProjectRef, {
                    projectName: name,
                    description: newProjectDescriptionInput.value.trim() || '',
                    content: JSON.stringify([]),
                    priorities: JSON.stringify([]),
                    createdAt: new Date().toISOString()
                });
                
                console.log("Proyecto creado:", projectId);
                
                // Cerrar modal y limpiar
                newProjectModal.classList.add('hidden');
                newProjectNameInput.value = '';
                newProjectDescriptionInput.value = '';
                
                // Recargar lista y seleccionar nuevo proyecto
                await loadProjectsList();
                projectSelector.value = projectId;
                loadProject(projectId);
                
                loadingSpinner.classList.add('hidden');
                showMessage(`Proyecto "${name}" creado exitosamente`);
                
            } catch (error) {
                console.error("Error al crear proyecto:", error);
                showMessage(`Error al crear proyecto: ${error.message}`);
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- Eliminar proyecto ---
        async function deleteCurrentProject() {
            if (!currentProjectId) return;
            
            const projectName = projectSelector.options[projectSelector.selectedIndex]?.textContent || currentProjectId;
            
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar el proyecto "${projectName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                loadingSpinner.classList.remove('hidden');
                loadingText.textContent = "Eliminando proyecto...";
                
                const docPath = `artifacts/${appId}/public/data/projects/${currentProjectId}`;
                await deleteDoc(doc(db, docPath));
                
                console.log("Proyecto eliminado:", currentProjectId);
                
                // Limpiar datos
                projectData = [];
                priorityTasks = [];
                currentProjectId = null;
                localStorage.removeItem('lastSelectedProject');
                
                // Recargar lista de proyectos
                await loadProjectsList();
                
                loadingSpinner.classList.add('hidden');
                showMessage(`Proyecto "${projectName}" eliminado exitosamente`);
                
            } catch (error) {
                console.error("Error al eliminar proyecto:", error);
                showMessage(`Error al eliminar proyecto: ${error.message}`);
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- Crear nuevo Espacio de Trabajo ---
        async function createNewWorkspace() {
            if (!currentProjectId) {
                showMessage("Por favor, selecciona un proyecto primero");
                return;
            }
            
            const title = newWorkspaceTitleInput.value.trim();
            if (!title) {
                showMessage("Por favor, ingresa un t√≠tulo para el Espacio de Trabajo");
                return;
            }
            
            // Generar ID √∫nico
            const workspaceId = String(projectData.length + 1);
            
            // Crear nuevo espacio de trabajo
            const newWorkspace = {
                id: workspaceId,
                title: title,
                tasks: []
            };
            
            projectData.push(newWorkspace);
            await saveCoreProjectData();
            
            // Cerrar modal y limpiar
            newWorkspaceModal.classList.add('hidden');
            newWorkspaceTitleInput.value = '';
            
            // Re-renderizar
            renderProject();
            showMessage(`Espacio de Trabajo "${title}" creado exitosamente`);
        }

        // --- Crear nuevo Grupo de Tareas ---
        async function createNewTaskgroup() {
            if (!currentWorkspaceIdForTaskgroup) {
                showMessage("Error: No se especific√≥ el Espacio de Trabajo");
                return;
            }
            
            const title = newTaskgroupTitleInput.value.trim();
            if (!title) {
                showMessage("Por favor, ingresa un t√≠tulo para el Grupo de Tareas");
                return;
            }
            
            // Encontrar el espacio de trabajo
            const workspace = projectData.find(s => s.id === currentWorkspaceIdForTaskgroup);
            if (!workspace) {
                showMessage("Error: Espacio de Trabajo no encontrado");
                return;
            }
            
            // Generar ID √∫nico para el grupo
            const taskgroupId = `${currentWorkspaceIdForTaskgroup}.${workspace.tasks.length + 1}`;
            
            // Crear nuevo grupo de tareas
            const newTaskgroup = {
                id: taskgroupId,
                title: title,
                items: []
            };
            
            workspace.tasks.push(newTaskgroup);
            await saveCoreProjectData();
            
            // Guardar el ID del workspace antes de limpiarlo
            const workspaceId = currentWorkspaceIdForTaskgroup;
            
            // Cerrar modal y limpiar
            newTaskgroupModal.classList.add('hidden');
            newTaskgroupTitleInput.value = '';
            currentWorkspaceIdForTaskgroup = null;
            
            // Asegurar que el espacio est√© abierto
            openAccordions.add(workspaceId);
            
            // Re-renderizar
            renderProject();
            showMessage(`Grupo de Tareas "${title}" creado exitosamente`);
        }

        // --- Crear nueva Tarea ---
        async function createNewTask() {
            if (!currentSectionIdForTask || !currentSubsectionIdForTask) {
                showMessage("Error: No se especific√≥ el Grupo de Tareas");
                return;
            }
            
            const text = newTaskTextInput.value.trim();
            if (!text) {
                showMessage("Por favor, ingresa una descripci√≥n para la tarea");
                return;
            }
            
            // Encontrar el espacio de trabajo y el grupo
            const workspace = projectData.find(s => s.id === currentSectionIdForTask);
            if (!workspace) {
                showMessage("Error: Espacio de Trabajo no encontrado");
                return;
            }
            
            const taskgroup = workspace.tasks.find(t => t.id === currentSubsectionIdForTask);
            if (!taskgroup) {
                showMessage("Error: Grupo de Tareas no encontrado");
                return;
            }
            
            // Generar ID √∫nico para la tarea
            const taskId = `${currentSubsectionIdForTask}.${taskgroup.items.length + 1}`;
            
            // Crear nueva tarea
            const newTask = {
                id: taskId,
                text: text,
                status: '‚ùå', // Por defecto no iniciado
                note: ''
            };
            
            taskgroup.items.push(newTask);
            await saveCoreProjectData();
            
            // Guardar los IDs antes de limpiarlos
            const sectionId = currentSectionIdForTask;
            const subsectionId = currentSubsectionIdForTask;
            
            // Cerrar modal y limpiar
            newTaskModal.classList.add('hidden');
            newTaskTextInput.value = '';
            currentSectionIdForTask = null;
            currentSubsectionIdForTask = null;
            
            // Asegurar que el espacio y grupo est√©n abiertos
            openAccordions.add(sectionId);
            openAccordions.add(subsectionId);
            
            // Re-renderizar
            renderProject();
            showMessage(`Tarea "${text}" creada exitosamente`);
        }

        // --- Inicializar sistema de proyectos ---
        function setupFirestoreListener() {
            // Cargar lista de proyectos
            loadProjectsList();
        }
        
        async function saveInitialData() {
            if (!projectDocRef) return;
            try {
                // Obtener datos actuales para preservar nombre y descripci√≥n
                const currentDoc = await getDoc(projectDocRef);
                const currentData = currentDoc.exists() ? currentDoc.data() : {};
                
                await setDoc(projectDocRef, {
                    projectName: currentData.projectName || "Nuevo Proyecto",
                    description: currentData.description || '',
                    content: JSON.stringify(projectData),
                    priorities: JSON.stringify(priorityTasks),
                    createdAt: currentData.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                console.log("Proyecto guardado.");
            } catch (error) {
                console.error("Error al guardar datos iniciales:", error);
                showMessage(`Error al guardar: ${error.message}`);
            }
        }

        function renderProject() {
            const projectContainer = document.getElementById('project-container');
            if (!projectContainer) return;
            savedScrollY = window.scrollY;
            projectContainer.innerHTML = ''; 

            if (projectData.length === 0) {
                projectContainer.innerHTML = '<p class="text-gray-400">Este proyecto est√° vac√≠o. Los datos pueden estar cargando.</p>';
                return;
            }

            projectData.forEach(section => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'bg-gray-800 rounded-lg shadow-md overflow-hidden';
                
                const sectionHeader = document.createElement('h2');
                sectionHeader.className = 'text-2xl font-bold text-white p-4 bg-purple-900 bg-opacity-30 border-b border-purple-700 accordion-header flex justify-between items-center';
                sectionHeader.title = 'Espacio de Trabajo';
                
                const sectionTitleDiv = document.createElement('div');
                const sectionArrow = document.createElement('span');
                sectionArrow.className = 'accordion-arrow';
                sectionArrow.textContent = '‚ñ∂';
                
                sectionTitleDiv.appendChild(sectionArrow);
                sectionTitleDiv.appendChild(document.createTextNode(section.title));
                sectionHeader.appendChild(sectionTitleDiv);

                const sectionHasNotes = section.tasks.some(sub => 
                    sub.items.some(item => item.note && item.note.trim() !== '')
                );
                if (sectionHasNotes) {
                    const noteIndicator = document.createElement('span');
                    noteIndicator.className = 'text-xl text-blue-400 mr-2';
                    noteIndicator.textContent = 'üí¨';
                    sectionHeader.appendChild(noteIndicator);
                }
                // Bot√≥n para agregar Grupo de Tareas dentro de este Espacio
                const addTaskgroupBtn = document.createElement('button');
                addTaskgroupBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-xs ml-2';
                addTaskgroupBtn.textContent = '+ Grupo';
                addTaskgroupBtn.onclick = (e) => {
                    e.stopPropagation();
                    currentWorkspaceIdForTaskgroup = section.id;
                    newTaskgroupModal.classList.remove('hidden');
                    newTaskgroupTitleInput.focus();
                };
                sectionHeader.appendChild(addTaskgroupBtn);
                
                sectionEl.appendChild(sectionHeader);

                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'p-4 space-y-4';
                
                if (openAccordions.has(section.id)) {
                    tasksContainer.classList.remove('hidden');
                    sectionHeader.classList.add('open');
                    sectionArrow.textContent = '‚ñº';
                } else {
                    tasksContainer.classList.add('hidden');
                    sectionArrow.textContent = '‚ñ∂';
                }
                
                sectionHeader.onclick = () => {
                    sectionHeader.classList.toggle('open');
                    tasksContainer.classList.toggle('hidden');
                    sectionArrow.textContent = tasksContainer.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
                    
                    if (tasksContainer.classList.contains('hidden')) {
                        openAccordions.delete(section.id);
                    } else {
                        openAccordions.add(section.id);
                    }
                };

                section.tasks.forEach(subsection => {
                    const subsectionEl = document.createElement('div');
                    subsectionEl.className = 'pl-4 border-l-2 border-blue-600';
                    
                    const subsectionTitle = document.createElement('h3');
                    subsectionTitle.className = 'text-lg font-semibold text-blue-300 mb-2 accordion-header flex justify-between items-center p-2 rounded-md';
                    subsectionTitle.title = 'Grupo de Tareas';
                    
                    const subsectionTitleDiv = document.createElement('div');
                    const subsectionArrow = document.createElement('span');
                    subsectionArrow.className = 'accordion-arrow';
                    subsectionArrow.textContent = '‚ñ∂';

                    subsectionTitleDiv.appendChild(subsectionArrow);
                    subsectionTitleDiv.appendChild(document.createTextNode(subsection.title));
                    subsectionTitle.appendChild(subsectionTitleDiv);

                    const subsectionHasNotes = subsection.items.some(item => item.note && item.note.trim() !== '');
                    if (subsectionHasNotes) {
                        const noteIndicator = document.createElement('span');
                        noteIndicator.className = 'text-lg text-blue-400 mr-2';
                        noteIndicator.textContent = 'üí¨';
                        subsectionTitle.appendChild(noteIndicator);
                    }
                    
                    // Bot√≥n para agregar Tarea dentro de este Grupo
                    const addTaskBtn = document.createElement('button');
                    addTaskBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-xs ml-2';
                    addTaskBtn.textContent = '+ Tarea';
                    addTaskBtn.onclick = (e) => {
                        e.stopPropagation();
                        currentSectionIdForTask = section.id;
                        currentSubsectionIdForTask = subsection.id;
                        newTaskModal.classList.remove('hidden');
                        newTaskTextInput.focus();
                    };
                    subsectionTitle.appendChild(addTaskBtn);
                    
                    subsectionEl.appendChild(subsectionTitle);

                    const itemsList = document.createElement('ul');
                    itemsList.className = 'space-y-2 pl-6';

                    if (openAccordions.has(subsection.id)) {
                        itemsList.classList.remove('hidden');
                        subsectionTitle.classList.add('open');
                        subsectionArrow.textContent = '‚ñº';
                    } else {
                        itemsList.classList.add('hidden');
                        subsectionArrow.textContent = '‚ñ∂';
                    }

                    subsectionTitle.onclick = (e) => {
                        e.stopPropagation();
                        subsectionTitle.classList.toggle('open');
                        itemsList.classList.toggle('hidden');
                        subsectionArrow.textContent = itemsList.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
                        
                        if (itemsList.classList.contains('hidden')) {
                            openAccordions.delete(subsection.id);
                        } else {
                            openAccordions.add(subsection.id);
                        }
                    };

                    subsection.items.forEach(item => {
                        const itemEl = document.createElement('li');
                        itemEl.className = 'block p-2 rounded-md hover:bg-gray-700 transition-colors duration-150 task-item';
                        itemEl.dataset.status = item.status;

                        const mainItemRow = document.createElement('div');
                        mainItemRow.className = 'flex items-center justify-between';

                        const itemContent = document.createElement('div');
                        itemContent.className = 'flex items-center flex-grow min-w-0';

                        const statusIcon = document.createElement('span');
                        statusIcon.className = 'status-icon cursor-pointer text-xl mr-3';
                        statusIcon.textContent = item.status;
                        statusIcon.dataset.sectionId = section.id;
                        statusIcon.dataset.subsectionId = subsection.id;
                        statusIcon.dataset.itemId = item.id;
                        statusIcon.onclick = handleStatusClick;

                        const itemText = document.createElement('span');
                        itemText.className = 'flex-grow truncate';
                        itemText.textContent = item.text;

                        itemContent.appendChild(statusIcon);
                        itemContent.appendChild(itemText);

                        const noteIcon = document.createElement('span');
                        noteIcon.className = 'note-icon cursor-pointer text-lg ml-3 text-gray-500 hover:text-blue-400 flex-shrink-0';
                        noteIcon.textContent = 'üí¨';
                        noteIcon.dataset.sectionId = section.id;
                        noteIcon.dataset.subsectionId = subsection.id;
                        noteIcon.dataset.itemId = item.id;
                        noteIcon.onclick = handleNoteClick;

                        mainItemRow.appendChild(itemContent);
                        mainItemRow.appendChild(noteIcon);
                        
                        itemEl.appendChild(mainItemRow);

                        if (item.note && item.note.trim() !== '') {
                            const noteContent = document.createElement('div');
                            noteContent.className = 'note-display p-2 mt-2 ml-10 bg-gray-700 rounded-md text-sm text-gray-300';
                            noteContent.innerHTML = linkify(item.note);

                            noteContent.classList.add('cursor-pointer', 'hover:bg-gray-600', 'transition-colors');
                            noteContent.dataset.sectionId = section.id;
                            noteContent.dataset.subsectionId = subsection.id;
                            noteContent.dataset.itemId = item.id;
                            noteContent.onclick = handleNoteClick;
                            
                            itemEl.appendChild(noteContent);
                            noteIcon.classList.add('has-note');
                        } else {
                            noteIcon.classList.remove('has-note');
                        }
                        itemsList.appendChild(itemEl);
                    });

                    subsectionEl.appendChild(itemsList);
                    tasksContainer.appendChild(subsectionEl);
                });

                sectionEl.appendChild(tasksContainer);
                projectContainer.appendChild(sectionEl);
            });
            
            requestAnimationFrame(() => {
                window.scrollTo(0, savedScrollY);
            });
        }

        function renderPriorityTasks() {
            const priorityListEl = document.getElementById('priority-list');
            if (!priorityListEl) return;
            
            priorityListEl.innerHTML = '';
            
            if (priorityTasks.length === 0) {
                priorityListEl.innerHTML = '<li class="text-gray-500 italic">No hay tareas prioritarias.</li>';
                return;
            }

            priorityTasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'block p-2 rounded-md hover:bg-gray-700 transition-colors duration-150 task-item';
                li.dataset.status = task.status;

                const mainItemRow = document.createElement('div');
                mainItemRow.className = 'flex items-center justify-between';

                const itemContent = document.createElement('div');
                itemContent.className = 'flex items-center flex-grow min-w-0';

                const statusIcon = document.createElement('span');
                statusIcon.className = 'status-icon cursor-pointer text-xl mr-3';
                statusIcon.textContent = task.status;
                statusIcon.dataset.index = index;
                statusIcon.onclick = handlePriorityStatusClick;

                const itemText = document.createElement('span');
                itemText.className = 'flex-grow truncate';
                itemText.textContent = task.text;

                itemContent.appendChild(statusIcon);
                itemContent.appendChild(itemText);
                mainItemRow.appendChild(itemContent);

                const itemControls = document.createElement('div');
                itemControls.className = 'flex items-center flex-shrink-0 ml-3';

                const noteIcon = document.createElement('span');
                noteIcon.className = 'note-icon cursor-pointer text-lg text-gray-500 hover:text-blue-400';
                noteIcon.textContent = 'üí¨';
                noteIcon.dataset.index = index;
                noteIcon.onclick = handlePriorityNoteClick;
                itemControls.appendChild(noteIcon);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 hover:text-red-500 text-2xl font-bold ml-3 px-2';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.dataset.index = index;
                deleteBtn.onclick = handleDeletePriority;
                itemControls.appendChild(deleteBtn);
                
                mainItemRow.appendChild(itemControls);
                li.appendChild(mainItemRow);

                if (task.note && task.note.trim() !== '') {
                    const noteContent = document.createElement('div');
                    noteContent.className = 'note-display p-2 mt-2 ml-10 bg-gray-700 rounded-md text-sm text-gray-300';
                    noteContent.innerHTML = linkify(task.note);

                    noteContent.classList.add('cursor-pointer', 'hover:bg-gray-600', 'transition-colors');
                    noteContent.dataset.index = index;
                    noteContent.onclick = handlePriorityNoteClick;
                    
                    li.appendChild(noteContent);
                    noteIcon.classList.add('has-note');
                } else {
                    noteIcon.classList.remove('has-note');
                }

                priorityListEl.appendChild(li);
            });
        }
        
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(-5px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in { animation: fade-in 0.3s ease-out; }
        `;
        document.head.appendChild(styleSheet);

        function handleStatusClick(event) {
            const { sectionId, subsectionId, itemId } = event.currentTarget.dataset;
            
            const item = findItem({ sectionId, subsectionId, itemId });
            if (!item) return;

            switch (item.status) {
                case '‚ùå': item.status = '‚è≥'; break;
                case '‚è≥': item.status = '‚úÖ'; break;
                case '‚úÖ': item.status = '‚ùå'; break;
                default: item.status = '‚ùå';
            }
            saveCoreProjectData();
        }
        
        function handleNoteClick(event) {
            event.stopPropagation();
            const { sectionId, subsectionId, itemId } = event.currentTarget.dataset;
            
            currentEditingItem = { sectionId, subsectionId, itemId };
            
            const item = findItem(currentEditingItem);
            if (item) {
                noteTextarea.value = item.note || '';
                noteModal.classList.remove('hidden');
            }
        }

        function saveNote() {
            if (!currentEditingItem && currentEditingPriorityItemIndex === null) return;

            if (currentEditingPriorityItemIndex !== null) {
                const index = currentEditingPriorityItemIndex;
                if (priorityTasks[index]) {
                    priorityTasks[index].note = noteTextarea.value;
                    savePriorityTasks();
                }
            } 
            else if (currentEditingItem) {
                const item = findItem(currentEditingItem);
                if (item) {
                    item.note = noteTextarea.value;
                    saveCoreProjectData();
                }
            }
            
            hideNoteModal();
        }

        function hideNoteModal() {
            noteModal.classList.add('hidden');
            currentEditingItem = null;
            currentEditingPriorityItemIndex = null;
            noteTextarea.value = '';
        }

        function findItem({ sectionId, subsectionId, itemId }) {
            const section = projectData.find(s => s.id === sectionId);
            if (!section) return null;
            const subsection = section.tasks.find(s => s.id === subsectionId);
            if (!subsection) return null;
            return subsection.items.find(i => i.id === itemId);
        }

        async function saveCoreProjectData() {
            if (!projectDocRef) return;
            try {
                await setDoc(projectDocRef, { 
                    content: JSON.stringify(projectData),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                console.log("Proyecto guardado en Firestore.");
            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
                showMessage(`Error al guardar: ${error.message}`);
            }
        }
        
        function handleAddPriority() {
            const input = document.getElementById('priority-input');
            const text = input.value.trim();
            if (text === '') return;
            
            priorityTasks.push({ 
                id: crypto.randomUUID(), 
                text: text,
                status: '‚ùå',
                note: ''
            });
            input.value = '';
            
            savePriorityTasks(); 
        }

        function handleDeletePriority(event) {
            try {
                const index = parseInt(event.currentTarget.dataset.index, 10);
                if (isNaN(index) || index < 0 || index >= priorityTasks.length) {
                    console.error("√çndice de prioridad inv√°lido:", event.currentTarget.dataset.index);
                    return;
                }
                
                priorityTasks.splice(index, 1);
                
                savePriorityTasks();
            } catch (error) {
                console.error("Error al eliminar prioridad:", error);
                showMessage("Error al eliminar la tarea.");
            }
        }

        async function savePriorityTasks() {
            if (!projectDocRef) return;
            try {
                await setDoc(projectDocRef, { 
                    priorities: JSON.stringify(priorityTasks),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                console.log("Prioridades guardadas en Firestore.");
            } catch (error) {
                console.error("Error al guardar prioridades en Firestore:", error);
                showMessage(`Error al guardar prioridades: ${error.message}`);
            }
        }
        
        function handlePriorityStatusClick(event) {
            event.stopPropagation();
            const index = parseInt(event.currentTarget.dataset.index, 10);
            if (isNaN(index) || !priorityTasks[index]) return;

            const task = priorityTasks[index];
            
            switch (task.status) {
                case '‚ùå': task.status = '‚è≥'; break;
                case '‚è≥': task.status = '‚úÖ'; break;
                case '‚úÖ': task.status = '‚ùå'; break;
                default: task.status = '‚ùå';
            }
            savePriorityTasks();
        }

        function handlePriorityNoteClick(event) {
            event.stopPropagation();
            const index = parseInt(event.currentTarget.dataset.index, 10);
            if (isNaN(index) || !priorityTasks[index]) return;

            currentEditingPriorityItemIndex = index;
            currentEditingItem = null;
            
            const task = priorityTasks[index];
            noteTextarea.value = task.note || '';
            noteModal.classList.remove('hidden');
        }

        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');

        function showMessage(message) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function hideMessage() {
            messageModal.classList.add('hidden');
        }
        
        function linkify(text) {
            if (!text) return '';
            
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            
            const escapedText = document.createElement('div').appendChild(document.createTextNode(text)).parentNode.innerHTML;

            return escapedText.replace(urlRegex, function(url, match1, protocol, match2) {
                let fullUrl = url;
                if (match2) {
                    fullUrl = 'http://' + url; // <-- CORREGIDO AQU√ç
                }
                return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            }).replace(/\n/g, '<br>');
        }

        window.hideMessage = hideMessage;

        // --- Iniciar la aplicaci√≥n ---
        startApp();

        // --- Asignar Eventos a Botones ---
        saveNoteBtn.onclick = saveNote;
        cancelNoteBtn.onclick = hideNoteModal;
        googleLoginBtn.onclick = handleGoogleLogin; // Asignar evento al bot√≥n de login

        document.getElementById('add-priority-btn').onclick = handleAddPriority;
        window.handleDeletePriority = handleDeletePriority;
        window.handlePriorityStatusClick = handlePriorityStatusClick;
        window.handlePriorityNoteClick = handlePriorityNoteClick;

        // --- Event Listeners para Proyectos ---
        projectSelector.onchange = (e) => {
            const selectedProjectId = e.target.value;
            if (selectedProjectId) {
                loadProject(selectedProjectId);
            }
        };

        newProjectBtn.onclick = () => {
            newProjectModal.classList.remove('hidden');
            newProjectNameInput.focus();
        };

        createProjectBtn.onclick = createNewProject;
        cancelNewProjectBtn.onclick = () => {
            newProjectModal.classList.add('hidden');
            newProjectNameInput.value = '';
            newProjectDescriptionInput.value = '';
        };

        deleteProjectBtn.onclick = deleteCurrentProject;

        // Permitir crear proyecto con Enter
        newProjectNameInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                createNewProject();
            }
        };

        // --- Event Listeners para Espacios de Trabajo ---
        addWorkspaceBtn.onclick = () => {
            if (!currentProjectId) {
                showMessage("Por favor, selecciona un proyecto primero");
                return;
            }
            newWorkspaceModal.classList.remove('hidden');
            newWorkspaceTitleInput.focus();
        };

        createWorkspaceBtn.onclick = createNewWorkspace;
        cancelNewWorkspaceBtn.onclick = () => {
            newWorkspaceModal.classList.add('hidden');
            newWorkspaceTitleInput.value = '';
        };

        // Permitir crear workspace con Enter
        newWorkspaceTitleInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                createNewWorkspace();
            }
        };

        // --- Event Listeners para Grupos de Tareas ---
        createTaskgroupBtn.onclick = createNewTaskgroup;
        cancelNewTaskgroupBtn.onclick = () => {
            newTaskgroupModal.classList.add('hidden');
            newTaskgroupTitleInput.value = '';
            currentWorkspaceIdForTaskgroup = null;
        };

        // Permitir crear grupo con Enter
        newTaskgroupTitleInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                createNewTaskgroup();
            }
        };

        // --- Event Listeners para Tareas ---
        createTaskBtn.onclick = createNewTask;
        cancelNewTaskBtn.onclick = () => {
            newTaskModal.classList.add('hidden');
            newTaskTextInput.value = '';
            currentSectionIdForTask = null;
            currentSubsectionIdForTask = null;
        };

        // Permitir crear tarea con Enter
        newTaskTextInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                createNewTask();
            }
        };

    </script>
</body>
</html>